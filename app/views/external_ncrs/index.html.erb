<%# app/views/external_ncrs/index.html.erb %>
<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">External NCRs</h1>
    <%= link_to new_external_ncr_path,
        class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" do %>
      <svg class="-ml-1 mr-2 h-5 w-5 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
      </svg>
      New NCR
    <% end %>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <%= form_with url: external_ncrs_path, method: :get, local: true, class: "flex items-end gap-4" do |form| %>
      <div class="flex-1">
        <%= form.label :search, "Search NCRs", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_field :search,
            value: params[:search],
            placeholder: "Search by NCR number, customer, part number...",
            class: "border border-gray-300 rounded-md px-3 py-2 w-full" %>
      </div>

      <div>
        <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :status,
            options_for_select([
              ['All Statuses', 'all'],
              ['Draft', 'draft'],
              ['In Progress', 'in_progress'],
              ['Completed', 'completed']
            ], params[:status]),
            {},
            class: "border border-gray-300 rounded-md px-3 py-2" %>
      </div>

      <div>
        <%= form.label :document_status, "Documents", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :document_status,
            options_for_select([
              ['All NCRs', ''],
              ['With Documents', 'with_documents'],
              ['Missing Documents', 'missing_documents']
            ], params[:document_status]),
            {},
            class: "border border-gray-300 rounded-md px-3 py-2" %>
      </div>

      <div>
        <%= form.submit "Search", class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
        <%= link_to "Clear", external_ncrs_path, class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded ml-2" %>
      </div>
    <% end %>
  </div>

  <!-- NCRs Table -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <% if @external_ncrs.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              NCR Details
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Customer & Part
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Reference Info
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status & Progress
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @external_ncrs.each do |ncr| %>
            <tr class="hover:bg-gray-50">
              <!-- NCR Details -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                      <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= link_to ncr.display_name, ncr, class: "text-blue-600 hover:text-blue-900" %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= ncr.date.strftime("%d %b %Y") %>
                    </div>
                    <div class="flex items-center mt-1">
                      <% if ncr.has_document? %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                          <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                          </svg>
                          Document
                        </span>
                      <% else %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                          <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z" />
                          </svg>
                          Missing
                        </span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </td>

              <!-- Customer & Part -->
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  <div class="font-medium"><%= ncr.customer_name %></div>
                  <div class="text-gray-500">
                    <%= ncr.part_number %>-<%= ncr.part_issue %>
                  </div>
                  <% if ncr.part_description.present? %>
                    <div class="text-xs text-gray-400 mt-1">
                      <%= truncate(ncr.part_description, length: 40) %>
                    </div>
                  <% end %>
                </div>
              </td>

              <!-- Reference Info -->
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  <div>
                    <%= link_to ncr.release_note_number, ncr.release_note, class: "text-blue-600 hover:text-blue-900 font-medium" %>
                  </div>
                  <% if ncr.customer_ncr_number.present? %>
                    <div class="text-xs text-gray-500">
                      Customer NCR: <%= ncr.customer_ncr_number %>
                    </div>
                  <% end %>
                  <% if ncr.batch_quantity.present? || ncr.reject_quantity.present? %>
                    <div class="text-xs text-gray-500 mt-1">
                      <% if ncr.batch_quantity.present? %>Batch: <%= ncr.batch_quantity %><% end %>
                      <% if ncr.reject_quantity.present% %>
                        <% if ncr.batch_quantity.present? %> • <% end %>Reject: <%= ncr.reject_quantity %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </td>

              <!-- Status & Progress -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-col space-y-2">
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full <%= ncr.status_badge_class %>">
                    <%= ncr.status.humanize %>
                  </span>
                  <div class="text-xs text-gray-500">
                    Respondent: <%= ncr.respondent&.full_name || "Unassigned" %>
                  </div>
                  <% if ncr.can_advance_status? %>
                    <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded bg-yellow-100 text-yellow-800">
                      Ready to advance
                    </span>
                  <% end %>
                </div>
              </td>

              <!-- Actions -->
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <%= link_to "View", ncr, class: "text-blue-600 hover:text-blue-900" %>
                  <%= link_to "Edit", edit_external_ncr_path(ncr), class: "text-yellow-600 hover:text-yellow-900" %>
                  <% if ncr.can_advance_status? %>
                    <%= link_to "Advance", advance_status_external_ncr_path(ncr),
                        method: :patch,
                        class: "text-green-600 hover:text-green-900" %>
                  <% end %>
                  <% if ncr.has_document? %>
                    <%= link_to download_document_external_ncr_path(ncr),
                        class: "text-indigo-600 hover:text-indigo-900" do %>
                      <svg class="h-4 w-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    <% end %>
                  <% end %>
                  <% if ncr.status == 'draft' %>
                    <%= link_to ncr, method: :delete,
                        confirm: "Are you sure you want to delete this NCR?",
                        class: "text-red-600 hover:text-red-900" do %>
                      Delete
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No NCRs found</h3>
        <p class="mt-1 text-sm text-gray-500">
          <% if params[:search].present? || params[:status].present? || params[:document_status].present? %>
            No NCRs match your current search or filter criteria.
          <% else %>
            Get started by creating a new external NCR.
          <% end %>
        </p>
        <div class="mt-6">
          <%= link_to new_external_ncr_path,
              class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" do %>
            <svg class="-ml-1 mr-2 h-5 w-5 inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            New NCR
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <% if @external_ncrs.respond_to?(:current_page) && @external_ncrs.total_pages > 1 %>
    <div class="mt-6 flex justify-between items-center">
      <div class="text-sm text-gray-700">
        Showing <%= @external_ncrs.offset_value + 1 %> to <%= [@external_ncrs.offset_value + @external_ncrs.limit_value, @external_ncrs.total_count].min %> of <%= @external_ncrs.total_count %> NCRs
      </div>
      <div class="flex items-center space-x-2">
        <% if @external_ncrs.prev_page %>
          <%= link_to "← Previous", external_ncrs_path(page: @external_ncrs.prev_page, search: params[:search], status: params[:status], document_status: params[:document_status]),
              class: "px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
        <% end %>

        <span class="px-3 py-2 text-sm font-medium text-gray-700 bg-blue-50 border border-blue-300 rounded-md">
          Page <%= @external_ncrs.current_page %> of <%= @external_ncrs.total_pages %>
        </span>

        <% if @external_ncrs.next_page %>
          <%= link_to "Next →", external_ncrs_path(page: @external_ncrs.next_page, search: params[:search], status: params[:status], document_status: params[:document_status]),
              class: "px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Info Box -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-md p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">External NCR Management</h3>
        <div class="mt-2 text-sm text-blue-700">
          <p>External NCRs track non-conformance reports received from customers against our release notes. Each NCR requires the original document and includes our formal response with corrective and preventive actions. The respondent (assigned automatically to the creator) is responsible for completing all required fields and advancing the NCR through to completion.</p>
        </div>
      </div>
    </div>
  </div>
</div>
