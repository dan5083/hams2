<!-- app/views/quality_documents/_form.html.erb -->
<link href="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.css" rel="stylesheet">

<script>
// Load Better Table script immediately
if (typeof window.betterTableLoaded === 'undefined') {
  window.betterTableLoaded = false;
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.js';
  script.onload = () => { window.betterTableLoaded = true; };
  document.head.appendChild(script);
}
</script>

<%= form_with model: @document, local: true, class: "space-y-6" do |f| %>
  <% if @document.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(@document.errors.count, "error") %> prohibited this document from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% @document.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Basic Information Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= f.label :document_type, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :document_type,
            options_for_select(QualityDocument::DOCUMENT_TYPES.map { |k, v| [v, k] }, @document.document_type),
            { prompt: 'Select document type' },
            { class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm', required: true } %>
      </div>

      <div>
        <%= f.label :code, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :code,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm font-mono',
            required: true,
            placeholder: 'e.g., 001, 002, 003' %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :title,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
            required: true %>
      </div>

      <div>
        <%= f.label :current_issue_number, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :current_issue_number,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
            required: true, min: 1 %>
      </div>

      <div>
        <%= f.label :approved_by, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :approved_by,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm' %>
      </div>
    </div>
  </div>

  <!-- Referenced Documents Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Referenced Documents</h3>

    <div class="relative">
      <div class="relative">
        <input type="text"
               id="reference-search"
               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 pr-10 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
               placeholder="Search for documents to reference..."
               autocomplete="off">
        <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl hidden" id="clear-search">&times;</button>
      </div>

      <div id="reference-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>

      <div class="mt-3 flex flex-wrap gap-2 min-h-[2rem]" id="selected-references">
        <% if @document.content && @document.content['references'].present? %>
          <% @document.content['references'].each do |ref| %>
            <span class="inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium" data-code="<%= ref %>">
              <%= ref %>
              <button type="button" onclick="removeReference(this)" class="hover:text-purple-900 text-lg leading-none">&times;</button>
              <input type="hidden" name="document[references][]" value="<%= ref %>">
            </span>
          <% end %>
        <% end %>
      </div>

      <p class="mt-2 text-xs text-gray-500">Search and click to add document references</p>
    </div>
  </div>

  <!-- Document Sections -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Document Sections</h3>

    <div id="sections" class="space-y-4">
      <% sections = @document.content && @document.content['sections'] ? @document.content['sections'] : [] %>
      <% sections.each_with_index do |section, index| %>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 section-item" data-index="<%= index %>">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 text-white text-sm font-semibold section-number">
                <%= index + 1 %>
              </span>
              <span class="text-sm font-medium text-gray-700">Section <%= index + 1 %></span>
            </div>
            <button type="button" class="remove-section bg-red-500 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded">
              Remove
            </button>
          </div>

          <div class="space-y-3">
            <div>
              <%= label_tag "sections[#{index}][heading]", "Section Heading", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= text_field_tag "sections[#{index}][heading]", section['heading'],
                  class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
                  required: true,
                  placeholder: 'e.g., Purpose, Scope, Procedure' %>
            </div>

            <div>
              <%= label_tag "section_#{index}_content", "Section Content", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <input type="hidden" name="sections[<%= index %>][content]" id="section_<%= index %>_content_input" value="<%= section['content'].to_s.gsub('"', '&quot;').gsub("'", '&#39;') %>">
              <div id="section_<%= index %>_editor" class="quill-editor"></div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <button type="button" id="add-section" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      + Add Section
    </button>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center justify-between pt-6 border-t-2 border-gray-200">
    <div>
      <div class="flex gap-2">
        <%= f.submit 'Update', name: 'commit', value: 'Update',
            class: 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded' %>
        <%= f.submit 'Update & Reissue', name: 'commit', value: 'Update & Reissue',
            class: 'bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded' %>
      </div>
      <p class="mt-2 text-xs text-gray-500">Update saves changes. Update & Reissue increments the issue number.</p>
    </div>
    <%= link_to 'Cancel', @document.persisted? ? quality_document_path(@document) : quality_documents_path,
        class: 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded' %>
  </div>
<% end %>

<script>
(function() {
  'use strict';

  // Prevent multiple initializations
  if (window.qualityDocFormInitialized) return;
  window.qualityDocFormInitialized = true;

  window.quillInstances = window.quillInstances || new Map();

  // Wait for Better Table and initialize
  function initForm() {
    let attempts = 0;
    const checkInterval = setInterval(() => {
      attempts++;
      if (typeof QuillBetterTable !== 'undefined' || attempts > 40) {
        clearInterval(checkInterval);

        if (typeof QuillBetterTable !== 'undefined') {
          try {
            Quill.register({ 'modules/better-table': QuillBetterTable }, true);
            console.log('âœ“ Better Table registered');
          } catch(e) { console.error('Better Table registration failed:', e); }
        }

        initializeEditors();
        initializeReferences();
        initializeSections();
      }
    }, 50);
  }

  function initializeEditors() {
    document.querySelectorAll('.quill-editor').forEach(container => {
      if (container.querySelector('.ql-toolbar')) return;

      const match = container.id.match(/section_(\d+)_editor/);
      if (!match) return;

      const index = match[1];
      const input = document.getElementById(`section_${index}_content_input`);
      if (!input) return;

      const config = {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'], ['clean']
          ]
        },
        placeholder: 'Enter section content...'
      };

      if (typeof QuillBetterTable !== 'undefined') {
        config.modules.table = false;
        config.modules['better-table'] = {
          operationMenu: {
            items: {
              unmergeCells: { text: 'Unmerge' },
              insertColumnRight: { text: 'Insert column right' },
              insertColumnLeft: { text: 'Insert column left' },
              insertRowUp: { text: 'Insert row above' },
              insertRowDown: { text: 'Insert row below' },
              mergeCells: { text: 'Merge' },
              deleteColumn: { text: 'Delete column' },
              deleteRow: { text: 'Delete row' },
              deleteTable: { text: 'Delete table' }
            }
          }
        };
        config.modules.toolbar.splice(4, 0, ['better-table']);
      }

      const quill = new Quill(`#section_${index}_editor`, config);

      // Load content
      if (input.value) {
        try {
          quill.clipboard.dangerouslyPasteHTML(0, input.value);
        } catch(e) {
          console.error('Failed to load content:', e);
        }
      }

      quill.on('text-change', () => { input.value = quill.root.innerHTML; });
      window.quillInstances.set(index, quill);
    });
  }

  function initializeReferences() {
    const docs = <%= raw QualityDocument.where.not(id: @document.id).order(:document_type, :code).map { |d| { code: d.full_code, title: d.title } }.to_json %>;
    const search = document.getElementById('reference-search');
    const clear = document.getElementById('clear-search');
    const dropdown = document.getElementById('reference-dropdown');
    const container = document.getElementById('selected-references');

    if (!search) return;

    const selected = new Set(Array.from(container.querySelectorAll('[data-code]')).map(el => el.dataset.code));

    search.addEventListener('input', function() {
      const term = this.value.trim().toLowerCase();
      if (!term) {
        clear.classList.add('hidden');
        dropdown.classList.add('hidden');
        return;
      }

      clear.classList.remove('hidden');
      const filtered = docs.filter(d =>
        d.code.toLowerCase().includes(term) || d.title.toLowerCase().includes(term)
      );

      dropdown.innerHTML = filtered.length ? filtered.map(d => `
        <div class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm border-b ${selected.has(d.code) ? 'bg-purple-50' : ''}"
             data-code="${d.code}">
          <strong>${d.code}</strong> - ${d.title}
        </div>
      `).join('') : '<div class="px-4 py-3 text-sm text-gray-500 text-center">No documents found</div>';
      dropdown.classList.remove('hidden');
    });

    clear.addEventListener('click', () => {
      search.value = '';
      clear.classList.add('hidden');
      dropdown.classList.add('hidden');
    });

    dropdown.addEventListener('click', e => {
      const opt = e.target.closest('[data-code]');
      if (!opt) return;

      const code = opt.dataset.code;
      if (selected.has(code)) {
        selected.delete(code);
        container.querySelector(`[data-code="${code}"]`).remove();
        opt.classList.remove('bg-purple-50');
      } else {
        selected.add(code);
        container.insertAdjacentHTML('beforeend', `
          <span class="inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium" data-code="${code}">
            ${code}
            <button type="button" onclick="this.closest('span').remove()" class="hover:text-purple-900 text-lg">&times;</button>
            <input type="hidden" name="document[references][]" value="${code}">
          </span>
        `);
        opt.classList.add('bg-purple-50');
      }
    });

    document.addEventListener('click', e => {
      if (!e.target.closest('#reference-search') && !e.target.closest('#reference-dropdown')) {
        dropdown.classList.add('hidden');
      }
    });
  }

  function initializeSections() {
    let sectionIndex = <%= (@document.content && @document.content['sections'] ? @document.content['sections'].length : 0) %>;

    document.getElementById('add-section')?.addEventListener('click', function() {
      const container = document.getElementById('sections');
      const num = container.querySelectorAll('.section-item').length + 1;

      container.insertAdjacentHTML('beforeend', `
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 section-item">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 text-white text-sm font-semibold">${num}</span>
              <span class="text-sm font-medium text-gray-700">Section ${num}</span>
            </div>
            <button type="button" onclick="this.closest('.section-item').remove()" class="bg-red-500 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded">Remove</button>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Section Heading</label>
              <input type="text" name="sections[${sectionIndex}][heading]" required
                     class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                     placeholder="e.g., Purpose, Scope, Procedure">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Section Content</label>
              <input type="hidden" name="sections[${sectionIndex}][content]" id="section_${sectionIndex}_content_input">
              <div id="section_${sectionIndex}_editor" class="quill-editor"></div>
            </div>
          </div>
        </div>
      `);

      const config = {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'], ['clean']
          ]
        },
        placeholder: 'Enter section content...'
      };

      if (typeof QuillBetterTable !== 'undefined') {
        config.modules.table = false;
        config.modules['better-table'] = {
          operationMenu: {
            items: {
              unmergeCells: { text: 'Unmerge' },
              insertColumnRight: { text: 'Insert column right' },
              insertColumnLeft: { text: 'Insert column left' },
              insertRowUp: { text: 'Insert row above' },
              insertRowDown: { text: 'Insert row below' },
              mergeCells: { text: 'Merge' },
              deleteColumn: { text: 'Delete column' },
              deleteRow: { text: 'Delete row' },
              deleteTable: { text: 'Delete table' }
            }
          }
        };
        config.modules.toolbar.splice(4, 0, ['better-table']);
      }

      const quill = new Quill(`#section_${sectionIndex}_editor`, config);
      const input = document.getElementById(`section_${sectionIndex}_content_input`);
      quill.on('text-change', () => { input.value = quill.root.innerHTML; });
      window.quillInstances.set(sectionIndex, quill);
      sectionIndex++;
    });
  }

  // Initialize on Turbo load
  document.addEventListener('turbo:load', initForm);

  // Also initialize immediately if Turbo already loaded
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(initForm, 100);
  }
})();
</script>
