<!-- app/views/quality_documents/_form.html.erb -->
<%= form_with model: @document, local: true, class: "space-y-6" do |f| %>
  <% if @document.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(@document.errors.count, "error") %> prohibited this document from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% @document.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Basic Information Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= f.label :document_type, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :document_type,
            options_for_select(QualityDocument::DOCUMENT_TYPES.map { |k, v| [v, k] }, @document.document_type),
            { prompt: 'Select document type' },
            { class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm', required: true } %>
      </div>

      <div>
        <%= f.label :code, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :code,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm font-mono',
            required: true,
            placeholder: 'e.g., 001, 002, 003' %>
      </div>

      <div class="md:col-span-2">
        <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :title,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
            required: true %>
      </div>

      <div>
        <%= f.label :current_issue_number, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :current_issue_number,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
            required: true, min: 1 %>
      </div>

      <div>
        <%= f.label :approved_by, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :approved_by,
            class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm' %>
      </div>
    </div>
  </div>

  <!-- Referenced Documents Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Referenced Documents</h3>

    <div class="relative">
      <div class="relative">
        <input type="text"
               id="reference-search"
               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 pr-10 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
               placeholder="Search for documents to reference..."
               autocomplete="off">
        <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl hidden" id="clear-search">&times;</button>
      </div>

      <div id="reference-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>

      <div class="mt-3 flex flex-wrap gap-2 min-h-[2rem]" id="selected-references">
        <% if @document.content && @document.content['references'].present? %>
          <% @document.content['references'].each do |ref| %>
            <span class="inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium" data-code="<%= ref %>">
              <%= ref %>
              <button type="button" onclick="removeReference(this)" class="hover:text-purple-900 text-lg leading-none">&times;</button>
              <input type="hidden" name="document[references][]" value="<%= ref %>">
            </span>
          <% end %>
        <% end %>
      </div>

      <p class="mt-2 text-xs text-gray-500">Search and click to add document references</p>
    </div>
  </div>

  <!-- Document Sections -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Document Sections</h3>

    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
      <strong>Editor Tips:</strong> Use the toolbar to format text. Click the table icon to insert tables. Click inside a table to see table editing options.
    </div>

    <div id="sections" class="space-y-4">
      <% sections = @document.content && @document.content['sections'] ? @document.content['sections'] : [] %>
      <% sections.each_with_index do |section, index| %>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 section-item" data-index="<%= index %>">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 text-white text-sm font-semibold section-number">
                <%= index + 1 %>
              </span>
              <span class="text-sm font-medium text-gray-700">Section <%= index + 1 %></span>
            </div>
            <button type="button" class="remove-section bg-red-500 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded">
              Remove
            </button>
          </div>

          <div class="space-y-3">
            <div>
              <%= label_tag "sections[#{index}][heading]", "Section Heading", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= text_field_tag "sections[#{index}][heading]", section['heading'],
                  class: 'mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm',
                  required: true,
                  placeholder: 'e.g., Purpose, Scope, Procedure' %>
            </div>

            <div>
              <%= label_tag "section_#{index}_content", "Section Content", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <textarea name="sections[<%= index %>][content]"
                        id="section_<%= index %>_content"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm"><%= section['content'].to_s %></textarea>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <button type="button" id="add-section" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      + Add Section
    </button>
  </div>

  <!-- Hidden fields for reissue data (populated by modal) -->
  <input type="hidden" name="reissue_change_description" id="reissue_change_description_hidden">
  <input type="hidden" name="reissue_authorised_by" id="reissue_authorised_by_hidden">

  <!-- Form Actions -->
  <div class="flex items-center justify-between pt-6 border-t-2 border-gray-200">
    <div>
      <div class="flex gap-2">
        <%= f.submit 'Update', name: 'commit', value: 'Update',
            class: 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded' %>
        <button type="button" id="reissue-btn"
            class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded">
          Update &amp; Reissue
        </button>
      </div>
      <p class="mt-2 text-xs text-gray-500">Update saves changes. Update & Reissue increments the issue number.</p>
    </div>
    <%= link_to 'Cancel', @document.persisted? ? quality_document_path(@document) : quality_documents_path,
        class: 'bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded' %>
  </div>
<% end %>

<!-- Reissue Modal -->
<div id="reissue-modal" class="fixed inset-0 z-50 hidden">
  <div class="fixed inset-0 bg-black bg-opacity-50" id="reissue-modal-backdrop"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full relative">
      <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-t-lg px-6 py-4">
        <h3 class="text-lg font-bold text-white">Update & Reissue</h3>
        <p class="text-yellow-100 text-sm mt-1">
          This will increment the issue number to <strong>Issue <%= @document.current_issue_number + 1 %></strong>.
          Please provide the amendment details.
        </p>
      </div>

      <div class="p-6 space-y-4">
        <div>
          <label for="reissue_change_description" class="block text-sm font-medium text-gray-700 mb-1">
            Amendment Details <span class="text-red-500">*</span>
          </label>
          <textarea id="reissue_change_description" rows="4"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"
                    placeholder="Describe what was changed and why..."></textarea>
          <p id="reissue-description-error" class="mt-1 text-sm text-red-600 hidden">Amendment details are required.</p>
        </div>

        <div>
          <label for="reissue_authorised_by" class="block text-sm font-medium text-gray-700 mb-1">
            Authorised By (initials) <span class="text-red-500">*</span>
          </label>
          <input type="text" id="reissue_authorised_by"
                 class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm uppercase"
                 placeholder="e.g., CC, DB"
                 value="<%= @document.approved_by %>"
                 maxlength="10">
          <p id="reissue-authorised-error" class="mt-1 text-sm text-red-600 hidden">Authorised by is required.</p>
        </div>
      </div>

      <div class="bg-gray-50 rounded-b-lg px-6 py-4 flex justify-end gap-3">
        <button type="button" id="reissue-cancel"
                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
          Cancel
        </button>
        <button type="button" id="reissue-confirm"
                class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded">
          Confirm Reissue
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// TinyMCE editor instances tracking
window.editorInstances = window.editorInstances || new Map();

// TinyMCE configuration - preserves all HTML
const tinymceConfig = {
  height: 400,
  menubar: false,
  plugins: [
    'advlist', 'autolink', 'lists', 'link', 'table',
    'wordcount', 'code'
  ],
  toolbar: 'undo redo | formatselect | bold italic underline strikethrough | ' +
           'bullist numlist | link | table | removeformat | code',
  content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',

  // Critical settings for HTML preservation
  valid_elements: '*[*]',
  extended_valid_elements: '*[*]',
  valid_children: '+body[style]',

  // Preserve everything
  verify_html: false,
  cleanup: false,
  convert_urls: false,

  // Table settings - preserve all attributes
  table_use_colgroups: false,
  table_advtab: true,
  table_cell_advtab: true,
  table_row_advtab: true,

  // Paste settings - keep all formatting
  paste_retain_style_properties: 'all',
  paste_merge_formats: false,
  paste_remove_styles_if_webkit: false,
  paste_remove_spans: false,
  paste_as_text: false,

  // Don't strip any attributes or styles
  invalid_elements: '',
  invalid_styles: {},

  // Setup callback
  setup: function(editor) {
    editor.on('init', function() {
      console.log('âœ“ TinyMCE initialized for:', editor.id);
    });
  }
};

// FIX 1: Destroy any stale instance before initialising, rather than returning
// early. Stale instances are left behind when Turbo navigates without a full
// page reload, causing TinyMCE to skip init and leave raw HTML visible.
function initializeTinyMCE(textareaId) {
  const textarea = document.getElementById(textareaId);

  if (!textarea) {
    console.error('Missing textarea:', textareaId);
    return;
  }

  // Remove any stale instance left over from a previous Turbo navigation
  const existing = tinymce.get(textareaId);
  if (existing) {
    existing.remove();
  }

  tinymce.init({
    ...tinymceConfig,
    selector: `#${textareaId}`,
    target: textarea
  });
}

// Initialize all editors on page load
function initializeAllEditors() {
  console.log('Initializing TinyMCE instances...');

  document.querySelectorAll('textarea[id$="_content"]').forEach(textarea => {
    initializeTinyMCE(textarea.id);
  });
}

// Main initialization function
function initializePage() {
  // Available documents for reference
  const availableDocuments = <%= raw QualityDocument.where.not(id: @document.id).order(:document_type, :code).map { |d| { code: d.full_code, title: d.title } }.to_json %>;

  // Reference selection functionality
  const searchInput = document.getElementById('reference-search');
  const clearSearchBtn = document.getElementById('clear-search');
  const dropdown = document.getElementById('reference-dropdown');
  const selectedContainer = document.getElementById('selected-references');

  if (!searchInput || !dropdown || !selectedContainer) {
    console.error('Reference elements not found');
    return;
  }

  let selectedReferences = new Set();

  // Initialize with existing references
  document.querySelectorAll('#selected-references [data-code]').forEach(tag => {
    selectedReferences.add(tag.dataset.code);
  });

  function filterDocuments(searchTerm) {
    if (!searchTerm) return availableDocuments;

    const term = searchTerm.toLowerCase();
    return availableDocuments.filter(doc =>
      doc.code.toLowerCase().includes(term) ||
      doc.title.toLowerCase().includes(term)
    );
  }

  function renderDropdown(documents) {
    if (documents.length === 0) {
      dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500 text-center italic">No documents found</div>';
    } else {
      dropdown.innerHTML = documents.map(doc => `
        <div class="px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm border-b border-gray-100 last:border-0 ${selectedReferences.has(doc.code) ? 'bg-purple-50 text-purple-800' : ''}"
             data-code="${doc.code}"
             data-title="${doc.title}">
          <strong>${doc.code}</strong> - ${doc.title}
          <div class="text-gray-500 text-xs mt-0.5">${doc.title}</div>
        </div>
      `).join('');
    }
  }

  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.trim();

    if (searchTerm) {
      clearSearchBtn.classList.remove('hidden');
      const filtered = filterDocuments(searchTerm);
      renderDropdown(filtered);
      dropdown.classList.remove('hidden');
    } else {
      clearSearchBtn.classList.add('hidden');
      dropdown.classList.add('hidden');
    }
  });

  searchInput.addEventListener('focus', function() {
    if (this.value.trim()) {
      dropdown.classList.remove('hidden');
    }
  });

  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    this.classList.add('hidden');
    dropdown.classList.add('hidden');
    searchInput.focus();
  });

  dropdown.addEventListener('click', function(e) {
    const option = e.target.closest('[data-code]');
    if (!option) return;

    const code = option.dataset.code;

    if (selectedReferences.has(code)) {
      removeReferenceByCode(code);
    } else {
      addReference(code);
    }

    option.classList.toggle('bg-purple-50');
    option.classList.toggle('text-purple-800');
  });

  function addReference(code) {
    if (selectedReferences.has(code)) return;

    selectedReferences.add(code);

    const tag = document.createElement('span');
    tag.className = 'inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium';
    tag.dataset.code = code;
    tag.innerHTML = `
      ${code}
      <button type="button" onclick="removeReference(this)" class="hover:text-purple-900 text-lg leading-none">&times;</button>
      <input type="hidden" name="document[references][]" value="${code}">
    `;

    selectedContainer.appendChild(tag);
  }

  window.removeReference = function(button) {
    const tag = button.closest('[data-code]');
    const code = tag.dataset.code;
    selectedReferences.delete(code);
    tag.remove();

    const option = dropdown.querySelector(`[data-code="${code}"]`);
    if (option) {
      option.classList.remove('bg-purple-50', 'text-purple-800');
    }
  }

  function removeReferenceByCode(code) {
    selectedReferences.delete(code);
    const tag = selectedContainer.querySelector(`[data-code="${code}"]`);
    if (tag) tag.remove();
  }

  document.addEventListener('click', function(e) {
    if (!e.target.closest('#reference-search') && !e.target.closest('#reference-dropdown')) {
      dropdown.classList.add('hidden');
    }
  });

  // Section management
  window.sectionIndex = <%= (@document.content && @document.content['sections'] ? @document.content['sections'].length : 0) %>;

  const addSectionBtn = document.getElementById('add-section');
  const sectionsContainer = document.getElementById('sections');

  if (addSectionBtn && sectionsContainer) {
    // Remove any existing listeners by cloning the button
    const newAddSectionBtn = addSectionBtn.cloneNode(true);
    addSectionBtn.parentNode.replaceChild(newAddSectionBtn, addSectionBtn);

    newAddSectionBtn.addEventListener('click', function() {
      const sectionsDiv = document.getElementById('sections');
      const newSection = document.createElement('div');
      newSection.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 section-item';
      newSection.dataset.index = window.sectionIndex;

      const sectionNumber = document.querySelectorAll('#sections .section-item').length + 1;

      newSection.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 text-white text-sm font-semibold section-number">
              ${sectionNumber}
            </span>
            <span class="text-sm font-medium text-gray-700">Section ${sectionNumber}</span>
          </div>
          <button type="button" class="remove-section bg-red-500 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded">
            Remove
          </button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Section Heading</label>
            <input type="text" name="sections[${window.sectionIndex}][heading]"
                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                   required placeholder="e.g., Purpose, Scope, Procedure">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Section Content</label>
            <textarea name="sections[${window.sectionIndex}][content]"
                      id="section_${window.sectionIndex}_content"
                      class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm"></textarea>
          </div>
        </div>
      `;

      sectionsDiv.appendChild(newSection);

      // Initialize TinyMCE for new section
      const textareaId = `section_${window.sectionIndex}_content`;
      initializeTinyMCE(textareaId);

      window.sectionIndex++;
      newSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // Use event delegation for remove buttons
    sectionsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-section') || e.target.closest('.remove-section')) {
        const section = e.target.closest('.section-item');
        const index = section.dataset.index;

        // Remove TinyMCE instance if exists
        const textareaId = `section_${index}_content`;
        const editor = tinymce.get(textareaId);
        if (editor) {
          editor.remove();
        }

        section.remove();

        // Renumber remaining sections
        document.querySelectorAll('#sections .section-item').forEach((section, index) => {
          const numberBadge = section.querySelector('.section-number');
          const label = section.querySelector('.text-sm.font-medium');
          if (numberBadge) numberBadge.textContent = index + 1;
          if (label) label.textContent = `Section ${index + 1}`;
        });
      }
    });
  }

  // Initialize TinyMCE
  if (typeof tinymce !== 'undefined') {
    setTimeout(initializeAllEditors, 100);
  } else {
    console.error('TinyMCE not loaded');
  }

  // Reissue modal functionality
  const reissueBtn = document.getElementById('reissue-btn');
  const reissueModal = document.getElementById('reissue-modal');
  const reissueCancel = document.getElementById('reissue-cancel');
  const reissueConfirm = document.getElementById('reissue-confirm');
  const reissueBackdrop = document.getElementById('reissue-modal-backdrop');

  if (reissueBtn && reissueModal) {
    reissueBtn.addEventListener('click', function() {
      reissueModal.classList.remove('hidden');
      document.getElementById('reissue_change_description').focus();
    });

    function closeReissueModal() {
      reissueModal.classList.add('hidden');
      document.getElementById('reissue-description-error').classList.add('hidden');
      document.getElementById('reissue-authorised-error').classList.add('hidden');
    }

    reissueCancel.addEventListener('click', closeReissueModal);
    reissueBackdrop.addEventListener('click', closeReissueModal);

    reissueConfirm.addEventListener('click', function() {
      const description = document.getElementById('reissue_change_description').value.trim();
      const authorisedBy = document.getElementById('reissue_authorised_by').value.trim();
      let valid = true;

      if (!description) {
        document.getElementById('reissue-description-error').classList.remove('hidden');
        valid = false;
      } else {
        document.getElementById('reissue-description-error').classList.add('hidden');
      }

      if (!authorisedBy) {
        document.getElementById('reissue-authorised-error').classList.remove('hidden');
        valid = false;
      } else {
        document.getElementById('reissue-authorised-error').classList.add('hidden');
      }

      if (!valid) return;

      // Copy values into hidden fields on the form
      document.getElementById('reissue_change_description_hidden').value = description;
      document.getElementById('reissue_authorised_by_hidden').value = authorisedBy;

      // Inject commit value and submit the form
      const form = document.querySelector('form.space-y-6') || document.querySelector('form');
      const commitInput = document.createElement('input');
      commitInput.type = 'hidden';
      commitInput.name = 'commit';
      commitInput.value = 'Update & Reissue';
      form.appendChild(commitInput);

      // Trigger TinyMCE save so textareas have latest content
      if (typeof tinymce !== 'undefined') {
        tinymce.triggerSave();
      }

      form.submit();
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !reissueModal.classList.contains('hidden')) {
        closeReissueModal();
      }
    });
  }

  console.log('Form script loaded successfully');
}

// FIX 2: Tear down all TinyMCE editors before Turbo swaps the body.
// Registered once via a flag so it doesn't stack up across navigations.
if (!window._tinymceTurboCleanupRegistered) {
  window._tinymceTurboCleanupRegistered = true;
  document.addEventListener('turbo:before-render', function() {
    if (typeof tinymce !== 'undefined') {
      tinymce.remove();
    }
  });
}

// Initialize on both DOMContentLoaded and Turbo load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializePage);
} else {
  initializePage();
}

document.addEventListener('turbo:load', initializePage);
</script>
