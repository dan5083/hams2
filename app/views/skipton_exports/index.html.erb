<div class="max-w-4xl mx-auto p-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Skipton Invoice Export</h1>
      <%= link_to "Manage Mappings", skipton_mappings_path, class: "text-sm text-blue-600 hover:text-blue-800 underline" %>
    </div>

    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
      <h2 class="font-semibold mb-2">How to use:</h2>
      <ol class="list-decimal list-inside space-y-1 text-sm">
        <li>Export invoices from Xero as CSV</li>
        <li>Upload the file below</li>
        <li>If any customers are missing, add their Skipton IDs</li>
        <li>Download the Skipton-formatted CSV</li>
        <li>Upload to Skipton Business Finance</li>
      </ol>
    </div>

    <% if flash[:alert] %>
      <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice] %>
      <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded text-green-700">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- INLINE MISSING CUSTOMERS FORM -->
    <% if @missing_customers.present? %>
      <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
        <h3 class="font-semibold mb-2 text-yellow-900">‚ö†Ô∏è Missing Skipton IDs</h3>
        <p class="text-sm mb-4 text-yellow-800">
          <%= pluralize(@missing_customers.count, 'customer') %> need Skipton IDs before export can complete.
          Fill in the IDs below:
        </p>

        <%= form_with url: batch_create_skipton_mappings_path, method: :post, class: "space-y-3" do |f| %>
          <div class="bg-white p-4 rounded border max-h-96 overflow-y-auto space-y-3">
            <% @missing_customers.each_with_index do |customer_name, index| %>
              <div class="flex items-center gap-3 pb-3 border-b last:border-b-0">
                <div class="flex-1">
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Customer Name
                  </label>
                  <input type="text"
                         name="mappings[<%= index %>][xero_name]"
                         value="<%= customer_name %>"
                         readonly
                         class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
                </div>
                <div class="w-48">
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Skipton ID <span class="text-red-500">*</span>
                  </label>
                  <input type="text"
                         name="mappings[<%= index %>][skipton_id]"
                         placeholder="e.g. 083812-001"
                         required
                         class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>
            <% end %>
          </div>

          <div class="flex gap-3">
            <%= f.submit "Save Mappings & Retry Export",
                         class: "flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium cursor-pointer" %>
            <%= link_to "Cancel", skipton_exports_path,
                        class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium" %>
          </div>
        <% end %>

        <p class="text-xs mt-3 text-gray-600">
          üí° Don't have the Skipton IDs? Add the customers to Skipton first, then come back here.
        </p>
      </div>
    <% end %>

    <!-- UPLOAD FORM -->
    <%= form_with url: skipton_exports_path, method: :post, multipart: true, data: { turbo: false }, class: "space-y-4" do |f| %>
      <div>
        <label class="block text-sm font-medium mb-2">
          Select Xero Invoice Export (CSV)
        </label>
        <%= f.file_field :xero_file,
                         accept: ".csv",
                         required: true,
                         class: "block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2" %>
      </div>

      <div>
        <%= f.submit "Transform & Download",
                     class: "w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <!-- Stats -->
  <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
    <h3 class="font-semibold mb-2">‚úì Customer Mappings</h3>
    <p class="text-sm text-gray-700">
      <strong><%= SkiptonCustomerMapping.count %></strong> customers currently mapped to Skipton IDs
    </p>
    <p class="text-xs text-gray-600 mt-2">
      <%= link_to "View all mappings ‚Üí", skipton_mappings_path, class: "text-blue-600 hover:text-blue-800 underline" %>
    </p>
  </div>
</div>
