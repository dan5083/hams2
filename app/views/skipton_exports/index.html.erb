<div class="max-w-4xl mx-auto p-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-6">Skipton Invoice Export</h1>

    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
      <h2 class="font-semibold mb-2">How to use:</h2>
      <ol class="list-decimal list-inside space-y-1 text-sm">
        <li>Export invoices from Xero as CSV</li>
        <li>Upload the file below</li>
        <li>Download the Skipton-formatted CSV</li>
        <li>Upload to Skipton Business Finance</li>
      </ol>
      <p class="text-xs text-gray-600 mt-2">
        Customer mappings: <code class="bg-white px-2 py-1 rounded">config/skipton_customer_mappings.csv</code>
      </p>
    </div>

    <% if flash[:alert] %>
      <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if @missing_customers.present? %>
      <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
        <h3 class="font-semibold mb-2 text-yellow-900">‚ö†Ô∏è Missing Skipton IDs</h3>
        <p class="text-sm mb-3 text-yellow-800">
          Add these <%= @missing_customers.count %> customers to
          <code class="bg-white px-2 py-1 rounded font-mono text-xs">config/skipton_customer_mappings.csv</code>:
        </p>
        <div class="max-h-40 overflow-y-auto bg-white p-3 rounded border font-mono text-xs space-y-1">
          <% @missing_customers.each do |customer_name| %>
            <div><%= customer_name %>,<span class="text-gray-400">ADD_ID_HERE</span></div>
          <% end %>
        </div>
        <p class="text-xs mt-3 text-gray-600">
          Copy these lines, add the Skipton IDs, commit the file, and try again.
        </p>
      </div>
    <% end %>

    <%= form_with url: skipton_exports_path, method: :post, multipart: true, class: "space-y-4" do |f| %>
      <div>
        <label class="block text-sm font-medium mb-2">
          Select Xero Invoice Export (CSV)
        </label>
        <%= f.file_field :xero_file,
                         accept: ".csv",
                         required: true,
                         class: "block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2" %>
      </div>

      <div>
        <%= f.submit "Transform & Download",
                     class: "w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <!-- Mapping File Info -->
  <div class="mt-6 p-4 <%= @has_mappings ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200' %> border rounded-lg">
    <h3 class="font-semibold mb-2">
      <%= @has_mappings ? '‚úì' : '‚ö†Ô∏è' %> Customer Mapping File
    </h3>

    <% if @has_mappings %>
      <p class="text-sm text-gray-700 mb-2">
        Mapping file found at: <code class="bg-white px-2 py-1 rounded text-xs">config/skipton_customer_mappings.csv</code>
      </p>

      <div class="mt-3 text-sm">
        <p class="font-medium mb-1">Current mappings:</p>
        <div class="bg-white p-3 rounded border max-h-60 overflow-y-auto">
          <table class="w-full text-xs">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="text-left p-2">Customer Name</th>
                <th class="text-left p-2">Skipton ID</th>
              </tr>
            </thead>
            <tbody>
              <% CSV.foreach(@mapping_file, headers: true).each do |row| %>
                <tr class="border-t">
                  <td class="p-2"><%= row['Xero Name'] %></td>
                  <td class="p-2 font-mono"><%= row['Skipton ID'] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <p class="text-xs text-gray-600 mt-3">
        üí° To add new customers: edit the file in your IDE, commit, and deploy.
      </p>
    <% else %>
      <p class="text-sm text-yellow-800 mb-3">
        Create the mapping file to get started:
      </p>
      <pre class="bg-white p-3 rounded border text-xs">touch config/skipton_customer_mappings.csv</pre>

      <p class="text-sm text-yellow-800 mt-3 mb-2">Add this header and your customer mappings:</p>
      <pre class="bg-white p-3 rounded border text-xs">Xero Name,Skipton ID
Abbey Precision Ltd,081019-001
Another Customer Ltd,123456-001</pre>
    <% end %>
  </div>
</div>
