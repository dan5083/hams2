<div class="max-w-6xl mx-auto p-6 space-y-6">
  <!-- MAIN EXPORT SECTION -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-6">Skipton Invoice Export</h1>

    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
      <h2 class="font-semibold mb-2">How to use:</h2>
      <ol class="list-decimal list-inside space-y-1 text-sm">
        <li>Export invoices from Xero as CSV</li>
        <li>Upload the file below</li>
        <li>If any customers are missing, add their Skipton IDs in the form that appears</li>
        <li>Download the Skipton-formatted CSV</li>
        <li>Upload to Skipton Business Finance</li>
      </ol>
    </div>

    <% if flash[:alert] %>
      <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice] %>
      <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded text-green-700">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- INLINE MISSING CUSTOMERS FORM -->
    <% if @missing_customers.present? %>
      <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
        <h3 class="font-semibold mb-2 text-yellow-900">‚ö†Ô∏è Missing Skipton IDs</h3>
        <p class="text-sm mb-4 text-yellow-800">
          <%= pluralize(@missing_customers.count, 'customer') %> need Skipton IDs before export can complete.
          Fill in the IDs below:
        </p>

        <%= form_with url: batch_create_skipton_mappings_path, method: :post, class: "space-y-3" do |f| %>
          <div class="bg-white p-4 rounded border max-h-96 overflow-y-auto space-y-3">
            <% @missing_customers.each_with_index do |customer_name, index| %>
              <div class="flex items-center gap-3 pb-3 border-b last:border-b-0">
                <div class="flex-1">
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Customer Name
                  </label>
                  <input type="text"
                         name="mappings[<%= index %>][xero_name]"
                         value="<%= customer_name %>"
                         readonly
                         class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-sm">
                </div>
                <div class="w-48">
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Skipton ID <span class="text-red-500">*</span>
                  </label>
                  <input type="text"
                         name="mappings[<%= index %>][skipton_id]"
                         placeholder="e.g. 083812-001"
                         required
                         class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
              </div>
            <% end %>
          </div>

          <div class="flex gap-3">
            <%= f.submit "Save Mappings & Retry Export",
                         class: "flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium cursor-pointer" %>
            <%= link_to "Cancel", skipton_exports_path,
                        class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium" %>
          </div>
        <% end %>

        <p class="text-xs mt-3 text-gray-600">
          üí° Don't have the Skipton IDs? Add the customers to Skipton first, then come back here.
        </p>
      </div>
    <% end %>

    <!-- UPLOAD FORM -->
    <%= form_with url: skipton_exports_path, method: :post, multipart: true, data: { turbo: false }, class: "space-y-4" do |f| %>
      <div>
        <label class="block text-sm font-medium mb-2">
          Select Xero Invoice Export (CSV)
        </label>
        <%= f.file_field :xero_file,
                         accept: ".csv",
                         required: true,
                         class: "block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2" %>
      </div>

      <div>
        <%= f.submit "Transform & Download",
                     class: "w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <!-- MAPPINGS MANAGEMENT SECTION -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-xl font-bold">Customer Mappings</h2>
        <p class="text-sm text-gray-600">
          <strong><%= @all_mappings.count %></strong> customers mapped to Skipton IDs
        </p>
      </div>
      <button onclick="document.getElementById('mappings-section').classList.toggle('hidden')"
              class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm font-medium">
        Toggle List
      </button>
    </div>

    <div id="mappings-section" class="space-y-4">
      <!-- Add New Mapping Form -->
      <div class="p-4 bg-gray-50 border border-gray-200 rounded">
        <h3 class="font-semibold mb-3 text-sm">Add New Mapping</h3>
        <%= form_with url: skipton_mappings_path, method: :post, class: "flex gap-3 items-end" do |f| %>
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Xero Customer Name <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   name="skipton_customer_mapping[xero_name]"
                   placeholder="e.g. Acme Manufacturing Ltd"
                   required
                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="w-48">
            <label class="block text-xs font-medium text-gray-700 mb-1">
              Skipton ID <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   name="skipton_customer_mapping[skipton_id]"
                   placeholder="e.g. 083812-001"
                   required
                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <%= f.submit "Add",
                       class: "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium cursor-pointer text-sm" %>
        <% end %>
      </div>

      <!-- Search -->
      <%= form_with url: skipton_exports_path, method: :get, class: "flex gap-3" do |f| %>
        <%= f.text_field :search,
                        value: params[:search],
                        placeholder: "Search by customer name or Skipton ID...",
                        class: "flex-1 px-4 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %>
        <%= f.submit "Search", class: "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium cursor-pointer text-sm" %>
        <% if params[:search].present? %>
          <%= link_to "Clear", skipton_exports_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-medium text-sm" %>
        <% end %>
      <% end %>

      <!-- Mappings Table -->
      <div class="border rounded-lg overflow-hidden">
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full">
            <thead class="bg-gray-100 border-b sticky top-0">
              <tr>
                <th class="text-left p-3 text-xs font-semibold">Xero Customer Name</th>
                <th class="text-left p-3 text-xs font-semibold w-40">Skipton ID</th>
                <th class="text-left p-3 text-xs font-semibold w-32">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if @displayed_mappings.any? %>
                <% @displayed_mappings.each do |mapping| %>
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 text-sm">
                      <%= mapping.xero_name %>
                    </td>
                    <td class="p-3 text-xs font-mono">
                      <%= mapping.skipton_id %>
                    </td>
                    <td class="p-3 text-xs">
                      <%= button_to "Delete",
                                    skipton_mapping_path(mapping),
                                    method: :delete,
                                    data: { confirm: "Delete mapping for '#{mapping.xero_name}'?" },
                                    class: "text-red-600 hover:text-red-800 underline" %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="3" class="p-8 text-center text-gray-500 text-sm">
                    <% if params[:search].present? %>
                      No mappings found matching "<%= params[:search] %>"
                    <% else %>
                      No mappings yet. Add your first mapping above.
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <% if @displayed_mappings.count < @all_mappings.count %>
        <p class="text-xs text-gray-600 text-center">
          Showing <%= @displayed_mappings.count %> of <%= @all_mappings.count %> mappings
          <%= "(filtered by search)" if params[:search].present? %>
        </p>
      <% end %>
    </div>
  </div>

  <!-- Help Section -->
  <div class="p-4 bg-blue-50 border border-blue-200 rounded">
    <h3 class="font-semibold mb-2 text-sm">üí° Tips</h3>
    <ul class="text-xs space-y-1 list-disc list-inside">
      <li>The Xero name must match <strong>exactly</strong> what appears in your Xero invoices</li>
      <li>Check capitalization, punctuation, and spacing - "Ltd" vs "Limited" matters</li>
      <li>Get Skipton IDs from your Skipton Business Finance account</li>
      <li>Use the search box to quickly find a specific customer</li>
    </ul>
  </div>
</div>
