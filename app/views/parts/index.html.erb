<%# app/views/parts/index.html.erb - Parts Index with Pagination %>
<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Parts & Manufacturing Instructions</h1>
    <%= link_to "New Part", new_part_path,
        class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
  </div>

  <!-- Search Filter -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <%= form_with url: parts_path, method: :get, local: true, class: "flex items-end gap-4" do |form| %>
      <div class="flex-1">
        <%= form.label :search, "Search Parts", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_field :search,
            value: params[:search],
            placeholder: "Search by part number, issue, or customer name...",
            class: "border border-gray-300 rounded-md px-3 py-2 w-full" %>
      </div>

      <div>
        <%= form.submit "Search", class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
        <%= link_to "Clear", parts_path, class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded ml-2" %>
      </div>
    <% end %>
  </div>

  <!-- Parts Table -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Part Number
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Customer
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Process Details
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Works Orders
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Status
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @parts.each do |part| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= link_to part.part_number, part, class: "text-blue-600 hover:text-blue-900" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= part.customer.name %>
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
              <div class="space-y-1">
                <!-- Treatment Types -->
                <% if part.anodising_types.any? %>
                  <div class="flex flex-wrap gap-1">
                    <% part.anodising_types.each do |type| %>
                      <%
                        badge_color = case type
                        when 'chemical_conversion'
                          'bg-orange-100 text-orange-800'
                        when 'hard_anodising'
                          'bg-purple-100 text-purple-800'
                        when 'chromic_anodising'
                          'bg-green-100 text-green-800'
                        when 'electroless_nickel_plating'
                          'bg-indigo-100 text-indigo-800'
                        else
                          'bg-blue-100 text-blue-800'
                        end
                      %>
                      <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded <%= badge_color %>">
                        <%= type.gsub('_anodising', '').gsub('_', ' ').titleize %>
                      </span>
                    <% end %>
                  </div>
                <% end %>

                <!-- Target Thicknesses -->
                <% if part.target_thicknesses.any? %>
                  <div class="flex flex-wrap gap-1">
                    <% part.target_thicknesses.first(3).each do |thickness| %>
                      <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-yellow-100 text-yellow-800">
                        <%= thickness %>μm
                      </span>
                    <% end %>
                    <% if part.target_thicknesses.length > 3 %>
                      <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-600">
                        +<%= part.target_thicknesses.length - 3 %> more
                      </span>
                    <% end %>
                  </div>
                <% end %>

                <!-- Alloys -->
                <% if part.alloys.any? %>
                  <div class="flex flex-wrap gap-1">
                    <% part.alloys.first(2).each do |alloy| %>
                      <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-green-100 text-green-800">
                        <%= alloy.humanize %>
                      </span>
                    <% end %>
                    <% if part.alloys.length > 2 %>
                      <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-600">
                        +<%= part.alloys.length - 2 %> more
                      </span>
                    <% end %>
                  </div>
                <% end %>

                <!-- Special Flags -->
                <div class="flex flex-wrap gap-1">
                  <% if part.aerospace_defense? %>
                    <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-red-100 text-red-800">
                      Aerospace/Defense
                    </span>
                  <% end %>
                  <% if part.selected_enp_heat_treatment.present? && part.selected_enp_heat_treatment != 'none' %>
                    <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-orange-100 text-orange-800">
                      ENP Heat Treatment
                    </span>
                  <% end %>
                  <% if part.has_enp_strip_mask_operations? %>
                    <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-purple-100 text-purple-800">
                      ENP Strip/Mask
                    </span>
                  <% end %>
                </div>

                <!-- Fallback to process type if no operations configured -->
                <% if part.anodising_types.empty? && part.process_type.present? %>
                  <span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">
                    <%= part.process_type.humanize %>
                  </span>
                <% end %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= part.works_orders.active.count %>
              <% if part.works_orders.count != part.works_orders.active.count %>
                (<%= part.works_orders.count %> total)
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-col space-y-1">
                <% if part.enabled %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    Enabled
                  </span>
                <% else %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                    Disabled
                  </span>
                <% end %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <%= link_to "View", part, class: "text-blue-600 hover:text-blue-900" %>
                <%= link_to "Edit", edit_part_path(part), class: "text-yellow-600 hover:text-yellow-900" %>
                <%= button_to part.enabled? ? "Disable" : "Enable",
                    toggle_enabled_part_path(part),
                    method: :patch,
                    form: {
                      class: "inline",
                      data: { confirm: "Are you sure you want to #{part.enabled? ? 'disable' : 'enable'} this part?" }
                    },
                    class: part.enabled? ? "text-red-600 hover:text-red-900" : "text-green-600 hover:text-green-900" %>
                <% if part.can_be_deleted? %>
                  <%= button_to "Delete", part_path(part),
                      method: :delete,
                      form: {
                        class: "inline",
                        data: { confirm: "Are you sure you want to delete this part? This cannot be undone." }
                      },
                      class: "text-red-600 hover:text-red-900" %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <% if @parts.empty? %>
      <div class="text-center py-8">
        <p class="text-gray-500">No parts found.</p>
        <%= link_to "Create your first part", new_part_path,
            class: "text-blue-600 hover:text-blue-900 font-medium" %>
      </div>
    <% end %>
  </div>

  <!-- Pagination -->
  <% if @parts.respond_to?(:current_page) %>
    <div class="mt-6 flex justify-between items-center">
      <div class="text-sm text-gray-700">
        Showing <%= @parts.offset_value + 1 %> to <%= [@parts.offset_value + @parts.limit_value, @parts.total_count].min %> of <%= @parts.total_count %> parts
      </div>
      <div class="flex items-center space-x-2">
        <% if @parts.prev_page %>
          <%= link_to "← Previous", parts_path(page: @parts.prev_page, search: params[:search]),
              class: "px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
        <% end %>

        <span class="px-3 py-2 text-sm font-medium text-gray-700 bg-blue-50 border border-blue-300 rounded-md">
          Page <%= @parts.current_page %> of <%= @parts.total_pages %>
        </span>

        <% if @parts.next_page %>
          <%= link_to "Next →", parts_path(page: @parts.next_page, search: params[:search]),
              class: "px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Info Box -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-md p-4">
    <div class="flex">
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">Integrated Parts & Manufacturing System</h3>
        <div class="mt-2 text-sm text-blue-700">
          <p>Each part includes complete manufacturing instructions with treatment selection, jig types, masking options, and process sequences. Parts are automatically normalized and can include up to 5 different treatment processes. Aerospace/Defense applications include mandatory water break tests and enhanced quality requirements.</p>
        </div>
      </div>
    </div>
  </div>
</div>
