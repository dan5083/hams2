<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {
        font-family: sans-serif;
        font-size: 9pt;
        margin: 0;
        padding: 1cm;
        --standard-border-width: 1pt;
        --standard-border-color: black;
        --standard-border-style: solid;
        box-sizing: border-box;
      }

      @page {
        size: A4 portrait;
        margin: 1cm;
      }

      /* Force Advice Note to print on right side (odd page) and single sided */
      .advice-note {
        page-break-before: right;
        page-break-after: always;
        max-height: calc(100vh - 2cm);
        overflow: hidden;
      }

      /* Certificate starts on next sheet, can use both sides */
      .certificate-page {
        page-break-before: right;
      }

      /* Allow certificate content to flow across pages */
      .certificate-content {
        max-height: none;
        overflow: visible;
      }

      /* Compressed mode for ENP/Aerospace jobs */
      .certificate-page.compressed .logo-header {
        margin-bottom: 0.5rem;
      }

      .certificate-page.compressed h1 {
        margin: 0.4rem 0;
        font-size: 1.2em;
      }

      .certificate-page.compressed h2 {
        font-size: 0.9em;
        margin: 0.5rem 0 0.3rem 0;
      }

      .certificate-page.compressed table {
        margin-bottom: 0.5rem;
      }

      .certificate-page.compressed .header-table {
        margin-bottom: 0.5rem;
      }

      .certificate-page.compressed .addresses {
        margin-bottom: 0.5rem;
      }

      .certificate-page.compressed .detail-table {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .certificate-page.compressed th,
      .certificate-page.compressed td {
        padding: 0.25rem;
      }

      .certificate-page.compressed .thickness-group {
        margin-bottom: 0.4rem;
      }

      .certificate-page.compressed .thickness-stats {
        padding: 0.2rem 0.3rem;
        margin-bottom: 0.2rem;
        font-size: 8pt;
      }

      .certificate-page.compressed .thickness-table {
        margin-top: 0.3rem;
        margin-bottom: 0.4rem;
      }

      .certificate-page.compressed .thickness-table th,
      .certificate-page.compressed .thickness-table td {
        padding: 0.2rem;
        font-size: 8pt;
      }

      .certificate-page.compressed .statement {
        margin: 0.5rem 0;
        padding: 0.4rem;
      }

      .certificate-page.compressed .signature-block {
        margin-top: 0.75rem;
      }

      .certificate-page.compressed .company-footer {
        margin-top: 0.5rem;
        font-size: 8pt;
        line-height: 1.3;
      }

      .certificate-page.compressed .readings-grid {
        gap: 0.15rem;
        padding: 0.2rem;
        font-size: 7.5pt;
      }

      .certificate-page.compressed .reading-value {
        padding: 0.15rem;
      }

      .logo-header {
        text-align: left;
        margin-bottom: 1rem;
      }

      .logo-header img {
        max-width: 250px;
        height: auto;
      }

      /* Company contact info styling */
      .company-contact {
        text-align: right;
        font-size: 8pt;
        color: #555;
        margin-top: 0.5rem;
        line-height: 1.2;
      }

      .company-contact a {
        color: #555;
        text-decoration: none;
      }

      .company-contact a:hover {
        text-decoration: underline;
      }

      h1 {
        text-align: center;
        margin: 0.75rem 0;
        font-size: 1.3em;
      }

      h2 {
        font-size: 0.95em;
        margin: 0.75rem 0 0.4rem 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.75rem;
      }

      th, td {
        border-color: var(--standard-border-color);
        border-style: var(--standard-border-style);
        border-width: var(--standard-border-width);
        padding: 0.4rem;
        vertical-align: top;
      }

      th {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: left;
        width: 30%;
      }

      .addresses {
        table-layout: fixed;
        margin-bottom: 1rem;
      }

      .address {
        width: 50%;
        vertical-align: top;
        padding: 0.4rem;
      }

      .address h2 {
        font-size: 0.9em;
        margin: 0 0 0.4rem 0;
        text-decoration: underline;
      }

      .address p {
        margin: 0;
        line-height: 1.3;
      }

      .header-table {
        margin-bottom: 1rem;
      }

      .detail-table {
        margin-top: 0.75rem;
        margin-bottom: 1rem;
      }

      .signature-table {
        table-layout: fixed;
        margin-top: 1rem;
      }

      .signature-table th {
        width: 25%;
      }

      .signature-table td {
        height: 2.5rem;
      }

      .signature-name {
        font-family: 'Times New Roman', serif;
        font-size: 1.1em;
        font-style: italic;
        font-weight: bold;
      }

      .statement {
        margin: 1rem 0;
        padding: 0.75rem;
        border: 1pt solid #ccc;
        background-color: #f8f9fa;
      }

      .signature-block {
        margin-top: 1.5rem;
        text-align: center;
      }

      .thickness-table {
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .thickness-table th {
        width: auto;
      }

      .thickness-group {
        margin-bottom: 0.75rem;
      }

      .thickness-group-header {
        background-color: #e9ecef;
        font-weight: bold;
        padding: 0.2rem 0.4rem;
        border-bottom: 2pt solid #ccc;
      }

      .thickness-stats {
        background-color: #f8f9fa;
        padding: 0.3rem 0.4rem;
        margin-bottom: 0.3rem;
        border: 1pt solid #ddd;
        font-size: 8.5pt;
      }

      .thickness-stats strong {
        color: #2563eb;
      }

      .gauge-info {
        background-color: #fffbeb;
        border: 1pt solid #fbbf24;
        padding: 0.4rem;
        margin-bottom: 0.5rem;
        font-size: 8.5pt;
        line-height: 1.4;
      }

      .gauge-info strong {
        color: #92400e;
      }

      .readings-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.2rem;
        padding: 0.3rem;
        background-color: #ffffff;
        border: 1pt solid #ddd;
        font-size: 8pt;
      }

      .reading-value {
        text-align: center;
        padding: 0.2rem;
        background-color: #eff6ff;
        border: 1pt solid #bfdbfe;
        border-radius: 2pt;
      }

      /* ENP measurements table styling */
      .enp-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 8.5pt;
      }

      .enp-table thead th {
        background-color: #e9ecef;
        font-weight: bold;
        text-align: center;
        padding: 0.3rem;
        border: 1pt solid #adb5bd;
      }

      .enp-table tbody td {
        text-align: center;
        padding: 0.3rem;
        border: 1pt solid #dee2e6;
      }

      .enp-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .enp-point {
        font-weight: bold;
        background-color: #e9ecef;
      }

      .enp-growth-positive {
        color: #16a34a;
        font-weight: bold;
      }

      .enp-growth-negative {
        color: #dc2626;
        font-weight: bold;
      }

      .compact {
        /* Can be applied to any table to reduce spacing */
      }

      /* Company footer styling */
      .company-footer {
        margin-top: 1rem;
        text-align: center;
        font-size: 8.5pt;
        color: #555;
        line-height: 1.4;
        border-top: 1pt solid #ddd;
        padding-top: 0.5rem;
      }

      .company-footer a {
        color: #555;
        text-decoration: none;
      }

      .company-footer a:hover {
        text-decoration: underline;
      }

      .customer-reference-row {
        padding: 0.5rem;
        background-color: #f0f9ff;
        border: 1pt solid #bae6fd;
        margin-bottom: 0.75rem;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <%
      # Determine if we need compressed mode (ENP or Aerospace)
      is_special_customer = @release_note.works_order.customer_order.customer.name.include?('Lufthansa')

      # Check if any measurements are ENP type
      has_enp = false
      if @release_note.has_thickness_measurements?
        measurements_by_type = @release_note.thickness_measurements_by_type
        measurements_by_type.each do |process_type, measurements|
          measurements.each do |measurement|
            if @release_note.treatment_is_enp?(measurement['process_type'])
              has_enp = true
              break
            end
          end
          break if has_enp
        end
      end

      # Aerospace is typically indicated by specification or customer type
      is_aerospace = @release_note.specification.to_s.match?(/AMS|BAC|DTD|DEF STAN|AEROSPACE/i) ||
                     @release_note.works_order.customer_order.customer.name.match?(/AEROSPACE|AIRCRAFT|AVIATION/i)

      use_compressed_mode = has_enp || is_aerospace

      # Extract CS-Order and Serial Number if present in customer reference
      cs_order = nil
      serial_no = nil
      if @release_note.works_order.customer_reference.present?
        ref = @release_note.works_order.customer_reference
        cs_order = ref.match(/CS-?Order[:\s]+([^\s\/]+)/i)&.captures&.first
        serial_no = ref.match(/S\/N[:\s]+([^\s\/]+)/i)&.captures&.first
      end
    %>

    <!-- Page 1: Advice Note (Always right side/odd page, single sided) -->
    <div class="advice-note">
      <!-- Logo Header -->
      <div class="logo-header">
        <%= image_tag("logo-with-company-name.png", alt: "Hard Anodising Surface Treatments Ltd") %>
      </div>

      <h1>Advice Note</h1>

      <!-- Header Information -->
      <table class="header-table">
        <tbody>
          <tr>
            <th>Release Note Number</th>
            <td>RN<%= @release_note.number %></td>
          </tr>
          <tr>
            <th>Date</th>
            <td><%= @release_note.date.strftime("%d/%m/%Y") %></td>
          </tr>
        </tbody>
      </table>

      <!-- Customer Details -->
      <table class="addresses">
        <tbody>
          <tr>
            <td class="address">
              <h2>Invoice To</h2>
              <p>
                <%= @release_note.works_order.customer_order.customer.display_name %><br/>
                <%= simple_format(@release_note.works_order.customer_order.customer.pdf_address) %>
              </p>
            </td>
            <td class="address">
              <h2>Deliver To</h2>
              <p>
                <%= @release_note.works_order.customer_order.customer.display_name %><br/>
                <%= simple_format(@release_note.works_order.customer_order.customer.pdf_address) %>
              </p>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Release Note Details -->
      <table class="detail-table">
        <tbody>
          <tr>
            <th>Customer Order</th>
            <td>
              <%= @release_note.works_order.customer_order.number %>
              <% if @release_note.works_order.respond_to?(:customer_order_line) && @release_note.works_order.customer_order_line.present? %>
                (line <%= @release_note.works_order.customer_order_line %>)
              <% end %>
            </td>
          </tr>
          <% if @release_note.works_order.customer_reference.present? %>
            <tr>
              <th>Customer Reference</th>
              <td><%= @release_note.works_order.customer_reference %></td>
            </tr>
          <% end %>
          <tr>
            <th>Part Number</th>
            <td><%= @release_note.works_order.part_number %></td>
          </tr>
          <tr>
            <th>Issue</th>
            <td><%= @release_note.works_order.part_issue %></td>
          </tr>
          <tr>
            <th>Description</th>
            <td><%= @release_note.works_order.part_description %></td>
          </tr>
          <tr>
            <th>Specification</th>
            <td><%= @release_note.specification %></td>
          </tr>
          <tr>
            <th>Quantity Accepted</th>
            <td><%= @release_note.quantity_accepted %></td>
          </tr>
          <tr>
            <th>Quantity Rejected</th>
            <td><%= @release_note.quantity_rejected %></td>
          </tr>
          <tr>
            <th>Our Works Order Number</th>
            <td>WO<%= @release_note.works_order.number %></td>
          </tr>
        </tbody>
      </table>

      <!-- Signature Table -->
      <table class="signature-table">
        <tbody>
          <tr>
            <th>Checked By</th>
            <td></td>
            <th>Received By</th>
            <td></td>
          </tr>
          <tr>
            <th>Date/Time</th>
            <td></td>
            <th>Date/Time</th>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Page 2+: Certificate of Conformity (Can use multiple sides) -->
    <div class="certificate-page <%= 'compressed' if use_compressed_mode %>">
      <div class="certificate-content">
        <!-- Logo Header -->
        <div class="logo-header">
          <%= image_tag("logo-with-company-name.png", alt: "Hard Anodising Surface Treatments Ltd") %>
          <!-- Company contact info in header -->
          <div class="company-contact">
            Firs Industrial Estate, Rickets Close, Kidderminster DY11 7QN<br/>
            Tel: 01562 747100 | <a href="https://www.hard-anodising.co.uk/">www.hard-anodising.co.uk</a>
          </div>
        </div>

        <h1>Certificate of Conformity</h1>

        <!-- Header Information -->
        <table class="header-table compact">
          <tbody>
            <tr>
              <th>Release Note Number</th>
              <td>RN<%= @release_note.number %></td>
            </tr>
            <tr>
              <th>Date</th>
              <td><%= @release_note.date.strftime("%d/%m/%Y") %></td>
            </tr>
          </tbody>
        </table>

        <!-- Invoice Address Only (removed deliver to) -->
        <table class="addresses compact">
          <tbody>
            <tr>
              <td class="address">
                <h2>Invoice To</h2>
                <p>
                  <%= @release_note.works_order.customer_order.customer.display_name %><br/>
                  <%= simple_format(@release_note.works_order.customer_order.customer.pdf_address) %>
                </p>
              </td>
              <td class="address">
                <!-- Empty space for balance -->
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Customer Reference (if present AND not special customer) - Full width row, no label -->
        <% if @release_note.works_order.customer_reference.present? && !is_special_customer %>
          <div class="customer-reference-row">
            <%= @release_note.works_order.customer_reference %>
          </div>
        <% end %>

        <!-- Release Note Details -->
        <table class="detail-table compact">
          <tbody>
            <tr>
              <th>Customer Order</th>
              <td>
                <%= @release_note.works_order.customer_order.number %>
                <% if @release_note.works_order.respond_to?(:customer_order_line) && @release_note.works_order.customer_order_line.present? %>
                  (line <%= @release_note.works_order.customer_order_line %>)
                <% end %>
                <% if cs_order.present? %>
                  / CS-Order: <%= cs_order %>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>Part Number</th>
              <td>
                <%= @release_note.works_order.part_number %>
                <% if serial_no.present? %>
                  / S/N: <%= serial_no %>
                <% end %>
              </td>
            </tr>
            <% unless is_special_customer %>
              <tr>
                <th>Issue</th>
                <td><%= @release_note.works_order.part_issue %></td>
              </tr>
            <% end %>
            <tr>
              <th>Description</th>
              <td><%= @release_note.works_order.part_description %></td>
            </tr>
            <tr>
              <th>Specification</th>
              <td><%= @release_note.specification %></td>
            </tr>
            <tr>
              <th>Quantity Accepted</th>
              <td><%= @release_note.quantity_accepted %></td>
            </tr>
            <tr>
              <th>Quantity Rejected</th>
              <td><%= @release_note.quantity_rejected %></td>
            </tr>
            <tr>
              <th>Our Works Order Number</th>
              <td>WO<%= @release_note.works_order.number %></td>
            </tr>
          </tbody>
        </table>

        <!-- Calibrated Thickness Measurements - UPDATED FOR ENP -->
        <% if @release_note.has_thickness_measurements? %>
          <h2>Calibrated Thickness Measurements</h2>

          <!-- Elcometer Gauge Information for Special Customers (anodic only) -->
          <% if is_special_customer %>
            <div class="gauge-info">
              <strong>Gauge Type:</strong> Elcometer 456/4, Serial # BD10146<br/>
              <strong>Probe Type:</strong> N1, Serial # BE23306
            </div>
          <% end %>

          <% measurements_by_type = @release_note.thickness_measurements_by_type %>
          <% measurements_by_type.each do |process_type, measurements| %>
            <div class="thickness-group">
              <div class="thickness-group-header">
                <%= process_type.humanize.gsub('_', ' ').titleize %>
              </div>
              <% measurements.each do |measurement| %>
                <%
                  display_name = measurement['display_name'] || measurement['process_type'].humanize.titleize
                  treatment_id = measurement['treatment_id']

                  # Check if this is ENP or anodic
                  is_enp = @release_note.treatment_is_enp?(measurement['process_type'])

                  # Only show display name if it differs from the group header
                  group_header_text = process_type.humanize.gsub('_', ' ').titleize
                  show_display_name = display_name != group_header_text
                %>

                <div style="margin-bottom: 0.5rem;">
                  <% if show_display_name %>
                    <div style="font-weight: bold; margin-bottom: 0.2rem; font-size: 9pt;">
                      <%= display_name %>
                    </div>
                  <% end %>

                  <% if is_enp %>
                    <!-- ENP Measurements Table -->
                    <%
                      enp_measurements = measurement['enp_measurements'] || []
                      next if enp_measurements.empty?

                      # Calculate statistics
                      valid_growths = enp_measurements.map { |m| m['growth_um'] }.compact.select { |g| g >= 0 }
                      if valid_growths.any?
                        mean = (valid_growths.sum / valid_growths.count.to_f).round(1)
                        min_val = valid_growths.min
                        max_val = valid_growths.max
                        count = valid_growths.count
                      end
                    %>

                    <!-- Statistics -->
                    <% if valid_growths.any? %>
                      <div class="thickness-stats">
                        <strong>Mean Growth: <%= mean %> µm</strong> |
                        Min: <%= min_val %> µm |
                        Max: <%= max_val %> µm |
                        Points: <%= count %>/6
                      </div>
                    <% end %>

                    <!-- ENP Measurements Table -->
                    <table class="thickness-table" style="margin-top: 0.5rem;">
                      <thead>
                        <tr>
                          <th style="width: 12%; text-align: center;">Point</th>
                          <th style="width: 29%; text-align: center;">Before (mm)</th>
                          <th style="width: 29%; text-align: center;">After (mm)</th>
                          <th style="width: 30%; text-align: center;">Growth (µm)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% enp_measurements.each do |measurement| %>
                          <tr>
                            <td style="text-align: center; font-weight: bold;"><%= measurement['point'] %></td>
                            <td style="text-align: center;"><%= measurement['start_mm'] ? sprintf('%.3f', measurement['start_mm']) : '—' %></td>
                            <td style="text-align: center;"><%= measurement['finish_mm'] ? sprintf('%.3f', measurement['finish_mm']) : '—' %></td>
                            <td style="text-align: center; <%= measurement['growth_um'] && measurement['growth_um'] < 0 ? 'color: #dc2626; font-weight: bold;' : 'color: #16a34a; font-weight: bold;' %>">
                              <%= measurement['growth_um'] ? sprintf('%.1f', measurement['growth_um']) : '—' %>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>

                  <% else %>
                    <!-- Anodic Measurements (existing format) -->
                    <%
                      readings = measurement['readings'] || []
                      next if readings.empty?

                      mean = (readings.sum / readings.count.to_f).round(1)
                      min_val = readings.min
                      max_val = readings.max
                      count = readings.count
                    %>

                    <!-- Statistics -->
                    <div class="thickness-stats">
                      <strong>Mean: <%= mean %> µm</strong> |
                      Min: <%= min_val %> µm |
                      Max: <%= max_val %> µm |
                      Count: <%= count %> readings
                    </div>

                    <!-- All Individual Readings -->
                    <div class="readings-grid">
                      <% readings.each do |reading| %>
                        <div class="reading-value"><%= reading %> µm</div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <!-- Statement -->
        <h2>Statement</h2>
        <div class="statement">
          <p><%= simple_format(@release_note.remarks) if @release_note.remarks.present? %></p>
        </div>

        <!-- Signature Block -->
        <div class="signature-block">
          <p>
            <span class="signature-name"><%= @release_note.issued_by.display_name %></span><br/>
            For and on behalf of Hard Anodising Surface Treatments Ltd
          </p>
        </div>

        <!-- Company Footer -->
        <div class="company-footer">
          <strong>Hard Anodising Surface Treatments Ltd</strong><br/>
          Firs Industrial Estate, Rickets Close, Kidderminster DY11 7QN<br/>
          Tel: 01562 747100 | <a href="https://www.hard-anodising.co.uk/">www.hard-anodising.co.uk</a>
        </div>
      </div>
    </div>
  </body>
</html>
