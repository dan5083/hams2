<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Release Note RN<%= @release_note.number %></h1>
    <div class="flex space-x-2">
      <%= link_to "PDF", pdf_release_note_path(@release_note),
          class: "bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded",
          target: "_blank" %>
      <% unless @release_note.voided || @release_note.invoice_item.present? %>
        <%= link_to "Edit", edit_release_note_path(@release_note),
            class: "bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" %>
        <% if @release_note.can_be_voided? %>
          <%= link_to "Void", void_release_note_path(@release_note),
              method: :patch,
              class: "bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded",
              data: { confirm: "Are you sure you want to void this release note? This cannot be undone." } %>
        <% end %>
      <% end %>
      <%= link_to "Back to Release Notes", release_notes_path,
          class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Release Note Details -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Release Note Details</h2>

      <dl class="space-y-3">
        <div>
          <dt class="text-sm font-medium text-gray-500">Release Note Number</dt>
          <dd class="text-sm text-gray-900 font-semibold">RN<%= @release_note.number %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Date</dt>
          <dd class="text-sm text-gray-900"><%= @release_note.date.strftime("%d/%m/%Y") %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Issued By</dt>
          <dd class="text-sm text-gray-900"><%= @release_note.issued_by.display_name %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Status</dt>
          <dd class="text-sm">
            <% if @release_note.voided %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                Voided
              </span>
            <% elsif @release_note.invoice_item.present? %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                Invoiced
              </span>
            <% elsif @release_note.can_be_invoiced? %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                Pending Invoice
              </span>
            <% else %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                Active
              </span>
            <% end %>
          </dd>
        </div>

        <% if @release_note.respond_to?(:remarks) && @release_note.remarks.present? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Remarks</dt>
            <dd class="text-sm text-gray-900"><%= simple_format(@release_note.remarks) %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Quantities -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Quantities</h2>

      <dl class="space-y-3">
        <div>
          <dt class="text-sm font-medium text-gray-500">Quantity Accepted</dt>
          <dd class="text-sm text-gray-900 font-semibold text-lg text-green-600">
            <%= @release_note.quantity_accepted %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Quantity Rejected</dt>
          <dd class="text-sm text-gray-900 font-semibold text-lg <%= @release_note.quantity_rejected > 0 ? 'text-red-600' : 'text-gray-400' %>">
            <%= @release_note.quantity_rejected %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Total Quantity</dt>
          <dd class="text-sm text-gray-900 font-semibold text-lg">
            <%= @release_note.total_quantity %>
          </dd>
        </div>

        <% if @release_note.can_be_invoiced? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Invoice Value</dt>
            <dd class="text-sm text-gray-900 font-semibold text-lg text-blue-600">
              £<%= sprintf("%.2f", @release_note.invoice_value) %>
            </dd>
          </div>
        <% end %>
      </dl>
    </div>
  </div>

  <!-- Thickness Measurements Section -->
  <% if @release_note.has_thickness_measurements? %>
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        Thickness Measurements
        <span class="text-sm font-normal text-gray-500">(Aerospace/Defense)</span>
      </h2>

      <% measurements_by_type = @release_note.thickness_measurements_by_type %>
      <% if measurements_by_type.any? %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <% measurements_by_type.each do |process_type, measurements| %>
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="text-lg font-medium text-gray-900 mb-3">
                <%= process_type.humanize.gsub('_', ' ').titleize %>
              </h3>

              <div class="space-y-2">
                <% measurements.each do |measurement| %>
                  <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                    <div>
                      <span class="text-sm font-medium text-gray-700">
                        <%= measurement['display_name'] || measurement['process_type'].humanize.titleize %>
                      </span>
                      <% if measurement['target_thickness'] && measurement['target_thickness'] > 0 %>
                        <span class="text-xs text-gray-500 block">
                          Target: <%= measurement['target_thickness'] %>μm
                        </span>
                      <% end %>
                    </div>
                    <div class="text-right">
                      <span class="text-sm font-semibold text-gray-900">
                        <%= measurement['measured_thickness'] %>μm
                      </span>
                      <% if measurement['target_thickness'] && measurement['target_thickness'] > 0 %>
                        <%
                          target = measurement['target_thickness'].to_f
                          measured = measurement['measured_thickness'].to_f
                          deviation_pct = ((measured - target) / target * 100).round(1)
                          deviation_class = deviation_pct.abs > 20 ? 'text-red-600' : (deviation_pct.abs > 10 ? 'text-yellow-600' : 'text-green-600')
                        %>
                        <span class="text-xs <%= deviation_class %> block">
                          <%= deviation_pct > 0 ? '+' : '' %><%= deviation_pct %>%
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Summary -->
        <div class="mt-4 p-3 bg-blue-50 rounded-md">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <p class="text-sm text-blue-700">
                <strong>Measurement Summary:</strong> <%= @release_note.thickness_measurements_summary %>
              </p>
            </div>
          </div>
        </div>
      <% else %>
        <p class="text-sm text-gray-500">No thickness measurements recorded.</p>
      <% end %>
    </div>
  <% elsif @release_note.requires_thickness_measurements? %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Thickness Measurements Required</h3>
          <p class="mt-1 text-sm text-yellow-700">
            This aerospace/defense part requires thickness measurements, but none have been recorded yet.
            <% unless @release_note.voided || @release_note.invoice_item.present? %>
              <%= link_to "Edit this release note", edit_release_note_path(@release_note),
                  class: "font-medium underline hover:no-underline" %> to add measurements.
            <% end %>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Works Order Details -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Works Order Details</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <dl class="space-y-3">
        <div>
          <dt class="text-sm font-medium text-gray-500">Works Order</dt>
          <dd class="text-sm text-gray-900">
            <%= link_to "WO#{@release_note.works_order.number}", @release_note.works_order,
                class: "text-blue-600 hover:text-blue-900" %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Customer Order</dt>
          <dd class="text-sm text-gray-900">
            <%= link_to @release_note.works_order.customer_order.number, @release_note.works_order.customer_order,
                class: "text-blue-600 hover:text-blue-900" %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Customer</dt>
          <dd class="text-sm text-gray-900"><%= @release_note.customer.name %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Part Number</dt>
          <dd class="text-sm text-gray-900 font-mono">
            <%= @release_note.works_order.part_number %>-<%= @release_note.works_order.part_issue %>
          </dd>
        </div>
      </dl>

      <dl class="space-y-3">
        <div>
          <dt class="text-sm font-medium text-gray-500">Description</dt>
          <dd class="text-sm text-gray-900"><%= @release_note.works_order.part_description %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Specification</dt>
          <dd class="text-sm text-gray-900"><%= @release_note.specification %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">WO Quantity</dt>
          <dd class="text-sm text-gray-900">
            <%= @release_note.works_order.quantity_released %>/<%= @release_note.works_order.quantity %>
          </dd>
        </div>

        <% if @release_note.works_order.part&.aerospace_defense? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Part Classification</dt>
            <dd class="text-sm">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                Aerospace/Defense
              </span>
            </dd>
          </div>
        <% end %>
      </dl>
    </div>
  </div>

  <!-- Customer Addresses -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Customer Information</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-2">Invoice To</h3>
        <div class="text-sm text-gray-900">
          <strong><%= @release_note.invoice_customer_name %></strong><br/>
          <%= simple_format(@release_note.invoice_address) if @release_note.invoice_address %>
        </div>
      </div>

      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-2">Deliver To</h3>
        <div class="text-sm text-gray-900">
          <strong><%= @release_note.delivery_customer_name %></strong><br/>
          <%= simple_format(@release_note.delivery_address) if @release_note.delivery_address %>
        </div>
      </div>
    </div>
  </div>

  <!-- Release Statement -->
  <% if @release_note.release_statement.present? %>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Release Statement</h2>
      <div class="text-sm text-gray-700">
        <%= simple_format(@release_note.release_statement) %>
      </div>
    </div>
  <% end %>

  <!-- Invoice Information -->
  <% if @release_note.invoice_item.present? %>
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Invoice Information</h2>

      <p class="text-sm text-gray-600 mb-2">This release note has been invoiced:</p>

      <dl class="space-y-2">
        <div>
          <dt class="text-sm font-medium text-gray-500 inline">Invoice:</dt>
          <dd class="text-sm text-gray-900 inline ml-2">
            <%= link_to @release_note.invoice_item.invoice.display_name, @release_note.invoice_item.invoice,
                class: "text-blue-600 hover:text-blue-900" %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500 inline">Amount:</dt>
          <dd class="text-sm text-gray-900 inline ml-2">
            £<%= sprintf("%.2f", @release_note.invoice_item.line_amount_inc_tax) %>
          </dd>
        </div>
      </dl>
    </div>
  <% end %>
</div>
