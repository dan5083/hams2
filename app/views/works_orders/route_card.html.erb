<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Route Card - WO<%= @works_order.number %></title>
    <style>
      body {
        counter-reset: page 1;
        font-size: 12pt;
        font-family: Arial, sans-serif;
        padding: 0 0.5cm 0 0;
        margin: 0;
        --standard-border-width: 0.25pt;
        --standard-border-color: #000;
        --standard-border-style: solid;
        --standard-padding: 0.25rem;
        position: relative;
      }

      @page {
        size: A4 portrait;
        margin: 1.5cm 2cm 1cm;
        counter-increment: page;
      }

      * {
        box-sizing: border-box;
      }

      .page-number::after {
        display: inline;
        content: counter(page);
      }

      .total-pages::after {
        display: inline;
        content: counter(pages);
      }

      .page-identification {
        font-size: 0.5rem;
        color: #666;
      }

      /* Aerospace/Defence Certification Overlay */
      .aerospace-certification-overlay {
        position: absolute;
        top: 0.1cm;
        left: 50%;
        transform: translateX(-50%) rotate(-15deg);
        width: 2.7in;
        height: 2.1in;
        background-image: url('<%= asset_path("aerospace-defence-certification.png") %>');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        transform-origin: center;
        z-index: 10;
        pointer-events: none;
      }

      header {
        display: block;
        width: 100%;
        margin-bottom: 1rem;
        position: relative;
      }

      .header-details {
        width: 100%;
      }

      .header-row {
        display: table;
        width: 100%;
        border-collapse: collapse;
      }

      .header-row-inner {
        display: table-row-group;
      }

      .header-row-inner2 {
        display: table-row;
      }

      .header-field-label, .header-field-value {
        display: table-cell;
        border-color: var(--standard-border-color);
        border-style: var(--standard-border-style);
        border-width: var(--standard-border-width);
        padding: var(--standard-padding);
        vertical-align: middle;
      }

      .header-field-label {
        font-weight: bold;
        background-color: #f5f5f5;
        width: 120px;
      }

      .header-field-value {
        background-color: white;
        width: 200px;
      }

      .header-field-value-wide {
        width: auto;
      }

      /* Force consistent column layout */
      .header-row-inner2 .header-field-label:nth-child(1) {
        width: 120px;
      }
      .header-row-inner2 .header-field-value:nth-child(2) {
        width: 200px;
      }
      .header-row-inner2 .header-field-label:nth-child(3) {
        width: 120px;
      }
      .header-row-inner2 .header-field-value:nth-child(4) {
        width: 200px;
      }

      .operations {
        margin-top: var(--standard-padding);
      }

      .operations table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      .operations th, .operations td {
        border-color: var(--standard-border-color);
        border-style: var(--standard-border-style);
        border-width: var(--standard-border-width);
        padding: var(--standard-padding);
        vertical-align: top;
      }

      .operations th {
        background-color: #f5f5f5;
        font-weight: bold;
        text-align: left;
      }

      .operations th:first-child {
        width: 1cm;
        text-align: center;
      }

      .operations th:nth-child(n+3) {
        width: 1.5cm;
      }

      .operations tbody {
        page-break-inside: avoid;
      }

      .operations td {
        line-height: 1.2;
      }

      p {
        margin: 0;
        padding: 0;
      }

      .variable-row {
        font-weight: bold;
        text-align: right;
        margin-top: 0.2rem;
      }

      .variable-name {
        display: inline-block;
      }

      /* Clean print styling */
      @media print {
        body {
          -webkit-print-color-adjust: exact;
          color-adjust: exact;
        }

        .aerospace-certification-overlay {
          background-image: url('<%= asset_path("aerospace-defence-certification.png") %>');
        }
      }

      /* Contract Review Checklist Styling */
      .contract-review-checklist {
        page-break-before: always;
        margin-top: 1cm;
      }

      .checklist-header {
        text-align: center;
        margin-bottom: 1rem;
      }

      .checklist-header h1 {
        font-size: 14pt;
        font-weight: bold;
        margin: 0 0 0.3rem 0;
      }

      .checklist-header h2 {
        font-size: 13pt;
        font-weight: bold;
        margin: 0 0 0.3rem 0;
      }

      .checklist-header h3 {
        font-size: 11pt;
        font-weight: normal;
        margin: 0;
      }

      .checklist-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        font-size: 9pt;
      }

      .checklist-table th,
      .checklist-table td {
        border: 1px solid #000;
        padding: 0.15cm;
        vertical-align: top;
      }

      .checklist-table th {
        background-color: #e0e0e0;
        font-weight: bold;
        text-align: center;
      }

      .checklist-item-col {
        width: 60%;
        text-align: left !important;
      }

      .checklist-yes-col,
      .checklist-no-col {
        width: 8%;
        text-align: center;
      }

      .checklist-action-col {
        width: 24%;
      }

      .checklist-table tbody td {
        min-height: 0.8cm;
      }
    </style>
  </head>
  <body>
    <!-- Aerospace/Defence Certification Overlay -->
    <% if @works_order&.aerospace_defense? %>
      <div class="aerospace-certification-overlay"></div>
    <% end %>

    <% if @works_order %>
      <%= render 'route_card_header', works_order: @works_order %>
    <% end %>

    <section class="operations">
      <%= render 'route_card_ops', operations: @operations %>
    </section>

    <div class="page-identification">
      WO<%= @works_order.number %> - Generated <%= Time.current.strftime("%d/%m/%Y %H:%M") %>
    </div>

    <!-- Aerospace/Defence Contract Review Checklist -->
    <% if @works_order&.aerospace_defense? %>
      <%
        # For Lufthansa Technik, only show checklist on first works order in customer order
        # For all other customers, show on every aerospace works order
        show_checklist = true
        customer_name = @works_order.customer&.name

        if customer_name == "Lufthansa Technik Landing Gear Services UK"
          # Get all active works orders in this customer order, sorted by number (ascending)
          all_wos_in_order = @works_order.customer_order.works_orders.active.order(:number)
          first_wo = all_wos_in_order.first

          # Only show checklist if this is the first (lowest numbered) works order
          show_checklist = (@works_order.id == first_wo&.id)
        end
      %>

      <% if show_checklist %>
      <div class="contract-review-checklist">
        <header class="checklist-header">
          <h1>HARD ANODISING SURFACE TREATMENTS LTD</h1>
          <h2>CONTRACT REVIEW CHECKLIST</h2>
          <h3>AEROSPACE/DEFENCE CONTRACT REVIEW CHECKLIST - WORKS ORDER NO: <%= @works_order.number %></h3>
        </header>

        <table class="checklist-table">
          <thead>
            <tr>
              <th class="checklist-item-col">ITEM</th>
              <th class="checklist-yes-col">YES</th>
              <th class="checklist-no-col">NO</th>
              <th class="checklist-action-col">ACTION TAKEN SIGN AND DATE</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1. Receipt of Order - (check all details are clear and unambiguous)</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>2. Order agrees with quotation?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>3. Ensure drawings and relevant specifications have been reviewed and are at the correct issue - check - Review Log. Ensure the Contract Review Result Sheet is available for relevent specifications so they can be used to facilitate the contract review.</td>
              <td></td>
              <td></td>
              <td><em>If the correct specification issues are not available put work on hold and contact the customer. Do not proceed if no review exists or no contract review sheet is available.</em></td>
            </tr>
            <tr>
              <td>4. Have key characteristics been identified on the drawing or as part of this review? (if yes Phil to determine if control plan required). Refer IP 2007 (page 7) to determine the relevant OCV data to be recorded.</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>5. Jigging Review? when viewing drawing, carry out a jigging review to ensure work holding, special threads, and component orientation suitable to minimise air locks is taken into account</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>6. Do Customer Quality Stipulations require frozen planning/quality plan?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>7. Are identified exceptional risks (metal/alloy etc)</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>8. Are delivery timescales achievable?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>9. Are inspection requirements identified and inspection/test equipment available and within calibration</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>10. Release certification determined</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>11. Is coating thickness verification possible?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>12. Test pieces required</td>
              <td></td>
              <td></td>
              <td><em>Customer Own In House (delete as applicable)</em></td>
            </tr>
            <tr>
              <td>13. Tooling and production equipment capable and available</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>14. Processing materials or required specifications available to meet delivery programme</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>15. Is a production Permit required?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>16. Does HASTL have the appropriate approval to process the order?</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>17. For timed processes, ensure works order refers to use of calibrated timers</td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <div class="page-identification">
          Form 2002/1 Iss.11
        </div>
      </div>
      <% end %>
    <% end %>
  </body>
</html>
