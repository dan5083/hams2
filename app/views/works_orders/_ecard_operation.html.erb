<%# app/views/works_orders/_ecard_operation.html.erb %>
<% is_signed_off = operation_signed_off?(works_order, operation) %>
<% is_contract_review = operation["display_name"].to_s.downcase.include?("contract review") %>

<div class="bg-white border-2 border-gray-300 <%= is_signed_off ? 'bg-green-50 border-green-300' : '' %>"
     data-controller="ecard-operation"
     data-ecard-operation-position-value="<%= operation['position'] %>"
     data-ecard-operation-works-order-id-value="<%= works_order.id %>"
     data-ecard-operation-signed-off-value="<%= is_signed_off %>"
     data-ecard-operation-display-name-value="<%= operation['display_name'] %>">

  <!-- Operation Header -->
  <div class="bg-gray-100 px-4 py-2 border-b border-gray-300 flex justify-between items-center">
    <h3 class="font-bold">Op <%= operation["position"] %>: <%= operation["display_name"] %></h3>
    <% if is_signed_off %>
      <span class="text-green-600 font-semibold" data-operation-status>✓ Signed Off</span>
    <% else %>
      <span class="text-blue-600 font-medium" data-operation-status>Pending</span>
    <% end %>
  </div>

  <!-- Operation Content -->
  <div class="p-4" data-ecard-operation-target="operationContent">
    <!-- Operation Instructions -->
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
      <p class="text-sm leading-relaxed"><%= operation["operation_text"] %></p>
      <% if operation["specifications"].present? %>
        <div class="mt-2 pt-2 border-t border-blue-300">
          <p class="text-xs text-blue-600 font-medium">Specifications:</p>
          <p class="text-xs text-blue-700"><%= operation["specifications"] %></p>
        </div>
      <% end %>
    </div>

    <% if is_contract_review %>
      <!-- Contract Review - Simple sign off -->
      <% if is_signed_off %>
        <div class="bg-green-50 border border-green-200 rounded p-3">
          <p class="text-sm text-green-700 mb-2">
            ✓ Contract review complete - customer requirements and specifications verified.
          </p>
          <p class="text-xs text-green-600">
            Manufacturing can now proceed with batch processing.
          </p>
        </div>
      <% else %>
        <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
          <p class="text-sm text-yellow-700 mb-3">
            Please verify customer requirements and specifications have been understood.
          </p>
          <%= form_with url: sign_off_operation_works_order_path(works_order),
                        method: :patch,
                        local: true,
                        data: { "ecard-operation-target": "signOffForm" } do |form| %>
            <%= form.hidden_field :operation_position, value: operation["position"] %>
            <%= form.submit "Sign Off Contract Review",
                class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium",
                data: {
                  "ecard-operation-target": "signOffButton",
                  action: "click->ecard-operation#beforeSignOff"
                } %>
          <% end %>
        </div>
      <% end %>

    <% else %>
      <!-- Regular Operations - Batch processing with current batch display -->
      <div class="border border-gray-300 <%= is_signed_off ? 'opacity-60' : '' %>"
           data-ecard-operation-target="batchSection">

        <!-- Current Batch Display -->
        <div data-controller="batch-tracker"
             data-batch-tracker-operation-position-value="<%= operation['position'] %>"
             data-batch-tracker-works-order-id-value="<%= works_order.id %>">

          <!-- Current Batch Status -->
          <div class="p-4">
            <div data-batch-tracker-target="currentBatch">
              <!-- Current batch info will be displayed here -->
              <div class="bg-gray-50 border border-gray-200 rounded p-3 mb-4">
                <div class="text-center text-gray-600 text-sm">
                  <div class="font-medium">Loading batch information...</div>
                </div>
              </div>
            </div>

            <!-- Sign Off Section -->
            <div class="<%= is_signed_off ? 'hidden' : '' %>"
                 data-batch-tracker-target="signOffSection">
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-sm text-green-700 mb-3">Ready to sign off this operation for the current batch?</p>

                <%= form_with url: sign_off_operation_works_order_path(works_order),
                              method: :patch,
                              local: true,
                              data: { "ecard-operation-target": "signOffForm" } do |form| %>
                  <%= form.hidden_field :operation_position, value: operation["position"] %>
                  <%= form.submit "Sign Off Operation",
                      class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium",
                      data: {
                        "ecard-operation-target": "signOffButton",
                        action: "click->ecard-operation#beforeSignOff"
                      } %>
                <% end %>
              </div>
            </div>

            <!-- Signed Off Status -->
            <% if is_signed_off %>
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-green-700">Operation Completed</span>
                    <span class="text-green-600">✓</span>
                  </div>
                  <div class="text-xs text-green-600">
                    Signed off <%= Time.current.strftime("%d/%m/%Y %H:%M") %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
