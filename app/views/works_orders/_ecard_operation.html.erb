<%# app/views/works_orders/_ecard_operation.html.erb %>
<div class="bg-white border-2 border-gray-300 <%= operation_signed_off?(works_order, operation) ? 'bg-green-50' : '' %>">
  <!-- Operation Header -->
  <div class="bg-gray-100 px-4 py-2 border-b border-gray-300 flex justify-between items-center">
    <h3 class="font-bold">Op <%= operation["position"] %>: <%= operation["display_name"] %></h3>
    <% if operation_signed_off?(works_order, operation) %>
      <span class="text-green-600 font-semibold">âœ“ Signed Off</span>
    <% end %>
  </div>

  <!-- Operation Content -->
  <div class="p-4">
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
      <p class="text-sm leading-relaxed"><%= operation["operation_text"] %></p>
    </div>

    <% if operation["display_name"].downcase.include?("contract review") %>
      <!-- Contract Review - No batch tracking, just sign off -->
      <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
        <p class="text-sm text-yellow-700 mb-3">Contract review complete - no batch tracking required</p>
        <% unless operation_signed_off?(works_order, operation) %>
          <%= button_to "Sign Off Contract Review",
              sign_off_operation_works_order_path(works_order),
              params: { operation_position: operation["position"] },
              method: :patch,
              class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium",
              data: { confirm: "Sign off contract review?" } %>
        <% end %>
      </div>
    <% else %>
      <!-- Regular Operations - Batch tracking with quantity -->
      <div class="border border-gray-300"
           data-controller="batch-tracker"
           data-batch-tracker-operation-position-value="<%= operation['position'] %>">
        <div class="bg-gray-50 px-4 py-2 border-b border-gray-300 flex justify-between items-center">
          <h4 class="font-semibold text-gray-700">Batch Tracking</h4>
          <% unless operation_signed_off?(works_order, operation) %>
            <button type="button"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm"
                    data-action="click->batch-tracker#addBatch">
              + Add Batch
            </button>
          <% end %>
        </div>

        <div class="p-4">
          <!-- Batch Headers -->
          <div class="grid grid-cols-6 gap-2 mb-2 text-xs font-semibold text-gray-600">
            <div>Batch</div>
            <div>Date</div>
            <div>Time</div>
            <div>Quantity</div>
            <div>Operator</div>
            <div>Notes</div>
          </div>

          <!-- Batch Rows Container -->
          <div data-batch-tracker-target="container" class="space-y-2 mb-4">
            <!-- Empty state -->
            <div class="text-sm text-gray-500 italic">No batches recorded yet</div>
          </div>

          <!-- Sign Off Section -->
          <% unless operation_signed_off?(works_order, operation) %>
            <div class="border-t border-gray-200 pt-4">
              <div class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-sm text-green-700 mb-3">Ready to sign off this operation?</p>
                <div class="flex items-center space-x-3">
                  <label class="text-sm font-medium">Total Quantity Processed:</label>
                  <input type="number"
                         data-batch-tracker-target="totalQty"
                         class="border border-gray-300 rounded px-2 py-1 w-20 text-sm"
                         readonly>
                  <%= button_to "Sign Off Operation",
                      sign_off_operation_works_order_path(works_order),
                      params: { operation_position: operation["position"] },
                      method: :patch,
                      class: "bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium",
                      data: { confirm: "Sign off this operation? This cannot be undone." } %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
