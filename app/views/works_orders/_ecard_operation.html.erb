<%# app/views/works_orders/_ecard_operation.html.erb - Updated with batch-based sign-offs %>
<div class="bg-white border-2 border-gray-300">
  <!-- Table Header -->
  <div class="bg-gray-50 border-b border-gray-300">
    <div class="flex p-3 font-semibold text-gray-700 text-sm">
      <div class="w-16 flex-shrink-0">Op #</div>
      <div class="flex-1 min-w-0">Operation Details</div>
      <div class="batch-signoffs flex-shrink-0" data-batch-manager-target="batchSignoffHeader">
        <!-- Batch sign-off headers will be populated by JavaScript -->
        <div class="text-center text-gray-500 text-xs">No Batches</div>
      </div>
    </div>
  </div>

  <!-- Operations Rows -->
  <% works_order.part.locked_operations.each_with_index do |operation, index| %>
    <% is_contract_review = operation["display_name"].to_s.downcase.include?("contract review") %>
    <% is_final_inspection = operation["display_name"].to_s.downcase.include?("final inspection") %>
    <% is_pack = operation["display_name"].to_s.downcase.include?("pack") %>
    <% is_batch_independent = is_contract_review || is_final_inspection || is_pack %>

    <div class="border-b border-gray-200 hover:bg-gray-50"
         data-controller="ecard-operation"
         data-ecard-operation-position-value="<%= operation['position'] %>"
         data-ecard-operation-works-order-id-value="<%= works_order.id %>"
         data-ecard-operation-display-name-value="<%= operation['display_name'] %>"
         data-ecard-operation-batch-independent-value="<%= is_batch_independent %>">

      <div class="flex p-3 items-start text-sm min-h-[80px]">

        <!-- Operation Number -->
        <div class="w-16 flex-shrink-0">
          <span class="font-bold text-lg"><%= operation["position"] %></span>
        </div>

        <!-- Operation Details -->
        <div class="flex-1 min-w-0 pr-4">
          <div class="font-medium text-gray-900 mb-2">
            <%= operation["display_name"] %>
          </div>

          <!-- Enhanced operation text with underscore inputs -->
          <div class="text-sm text-gray-700 leading-relaxed mb-2"
               data-controller="operation-text-inputs"
               data-operation-text-inputs-works-order-id-value="<%= works_order.id %>"
               data-operation-text-inputs-operation-position-value="<%= operation['position'] %>">

            <% operation_text = operation["operation_text"] || "" %>
            <% if operation_text.include?("_") %>
              <!-- Process text with underscores as inputs -->
              <div data-operation-text-inputs-target="textContainer">
                <%= render_operation_text_with_inputs(operation_text, works_order, operation['position']) %>
              </div>
            <% else %>
              <!-- Regular text display -->
              <div class="whitespace-pre-wrap break-words">
                <%= operation_text %>
              </div>
            <% end %>
          </div>

          <% if operation["specifications"].present? %>
            <div class="text-xs text-blue-600 mt-1">
              Spec: <%= operation["specifications"] %>
            </div>
          <% end %>
        </div>

        <!-- Batch Sign-off Buttons -->
        <div class="batch-signoffs flex-shrink-0"
             data-ecard-operation-target="batchSignoffs"
             data-batch-manager-target="operationSignoffs"
             data-operation-position="<%= operation['position'] %>">

          <% if is_batch_independent %>
            <!-- Single sign-off for batch-independent operations -->
            <div class="flex justify-center">
              <%= form_with url: sign_off_operation_works_order_path(works_order),
                            method: :patch,
                            local: true,
                            class: "inline" do |form| %>
                <%= form.hidden_field :operation_position, value: operation["position"] %>
                <%= form.hidden_field :batch_id, value: "independent" %>
                <%= form.submit "",
                    class: "w-10 h-10 rounded-full bg-green-500 hover:bg-green-600 text-white font-bold text-xs border-2 border-green-600 transition-colors duration-200",
                    title: "Sign off #{operation['display_name']}",
                    data: {
                      "ecard-operation-target": "signOffButton",
                      action: "click->ecard-operation#beforeSignOff",
                      confirm: "Sign off #{operation['display_name']}?"
                    } %>
              <% end %>
            </div>
          <% else %>
            <!-- Placeholder for batch-dependent operations - populated by JavaScript -->
            <div class="text-center text-gray-400 text-xs py-3">
              Create batches<br>to sign off
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Helper method for rendering operation text with input fields -->
<%
def render_operation_text_with_inputs(text, works_order, operation_position)
  # Split text by underscores and create input fields
  parts = text.split('_')
  result = []

  parts.each_with_index do |part, index|
    # Add the text part
    result << h(part) unless part.empty?

    # Add input field between parts (except after the last part)
    if index < parts.length - 1
      input_id = "op_#{operation_position}_input_#{index}"
      saved_value = works_order.customised_process_data.dig("operation_inputs", operation_position.to_s, index.to_s) || ""

      result << content_tag(:input, nil,
        type: "text",
        id: input_id,
        name: "operation_inputs[#{operation_position}][#{index}]",
        value: saved_value,
        class: "inline-block w-20 px-1 py-0 text-xs border border-gray-300 rounded mx-1 focus:outline-none focus:ring-1 focus:ring-blue-500",
        placeholder: "___",
        data: {
          "operation-text-inputs-target": "input",
          "input-index": index,
          action: "blur->operation-text-inputs#saveInput"
        }
      )
    end
  end

  result.join.html_safe
end
%>
