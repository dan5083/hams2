<%# app/views/works_orders/_ecard_operation.html.erb - Fixed layout and indentation %>
<div class="bg-white border-2 border-gray-300">
  <!-- Table Header -->
  <div class="bg-gray-50 border-b border-gray-300">
    <div class="flex p-3 font-semibold text-gray-700 text-sm">
      <div class="w-16 flex-shrink-0">Op #</div>
      <div class="flex-1 min-w-0 pr-4">Operation Details</div>
      <div class="batch-signoffs flex-shrink-0" data-batch-manager-target="batchSignoffHeader">
        <div class="text-center text-gray-500 text-xs py-2">No Batches</div>
      </div>
    </div>
  </div>

  <!-- Operations Rows -->
  <% works_order.part.locked_operations.each_with_index do |operation, index| %>
    <% is_contract_review = operation["display_name"].to_s.downcase.include?("contract review") %>
    <% is_final_inspection = operation["display_name"].to_s.downcase.include?("final inspection") %>
    <% is_pack = operation["display_name"].to_s.downcase.include?("pack") %>
    <% is_batch_independent = is_contract_review || is_final_inspection || is_pack %>

    <div class="border-b border-gray-200 hover:bg-gray-50"
         data-controller="ecard-operation"
         data-ecard-operation-position-value="<%= operation['position'] %>"
         data-ecard-operation-works-order-id-value="<%= works_order.id %>"
         data-ecard-operation-display-name-value="<%= operation['display_name'] %>"
         data-ecard-operation-batch-independent-value="<%= is_batch_independent %>">

      <div class="flex p-3 items-start text-sm min-h-[80px]">

        <!-- Operation Number -->
        <div class="w-16 flex-shrink-0">
          <span class="font-bold text-lg text-blue-600"><%= operation["position"] %></span>
        </div>

        <!-- Operation Details -->
        <div class="flex-1 min-w-0 pr-4">
          <!-- Operation Title -->
          <div class="font-medium text-gray-900 mb-2">
            <%= operation["display_name"] %>
          </div>

          <!-- Operation Text - FIXED: Remove indentation, improve formatting -->
          <div class="text-sm text-gray-700 leading-relaxed mb-2"
               data-controller="operation-text-inputs"
               data-operation-text-inputs-works-order-id-value="<%= works_order.id %>"
               data-operation-text-inputs-operation-position-value="<%= operation['position'] %>">

            <% operation_text = operation["operation_text"] || "" %>
            <% if operation_text.include?("_") %>
              <!-- Process text with underscores as inputs -->
              <div data-operation-text-inputs-target="textContainer" class="leading-relaxed">
                <%= render_operation_text_with_inputs(operation_text, works_order, operation['position']) %>
              </div>
            <% else %>
              <!-- Regular text display - FIXED: Remove whitespace-pre-wrap that was causing indentation -->
              <div class="break-words leading-relaxed">
                <%= simple_format(operation_text.strip, {}, sanitize: false) %>
              </div>
            <% end %>
          </div>

          <!-- Specifications -->
          <% if operation["specifications"].present? %>
            <div class="text-xs text-blue-600 mt-1 font-medium">
              Spec: <%= operation["specifications"] %>
            </div>
          <% end %>
        </div>

        <!-- Batch Sign-off Buttons -->
        <div class="batch-signoffs flex-shrink-0"
             data-ecard-operation-target="batchSignoffs"
             data-batch-manager-target="operationSignoffs"
             data-operation-position="<%= operation['position'] %>">

          <% if is_batch_independent %>
            <!-- Single sign-off for batch-independent operations -->
            <div class="flex justify-center">
              <% if operation_signed_off?(works_order, operation) %>
                <div class="w-12 h-12 rounded-full bg-green-500 border-2 border-green-600 flex items-center justify-center">
                  <span class="text-white text-lg font-bold">✓</span>
                </div>
              <% else %>
                <%= form_with url: sign_off_operation_works_order_path(works_order),
                              method: :patch,
                              local: true,
                              class: "inline" do |form| %>
                  <%= form.hidden_field :operation_position, value: operation["position"] %>
                  <%= form.hidden_field :batch_id, value: "independent" %>
                  <%= form.submit "",
                      class: "w-12 h-12 rounded-full bg-blue-500 hover:bg-green-600 text-white font-bold text-xs border-2 border-blue-600 hover:border-green-600 transition-all duration-200 cursor-pointer",
                      title: "Sign off #{operation['display_name']}",
                      value: "✓",
                      data: {
                        "ecard-operation-target": "signOffButton",
                        action: "click->ecard-operation#beforeSignOff",
                        confirm: "Sign off #{operation['display_name']}?"
                      } %>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <!-- Placeholder for batch-dependent operations - populated by JavaScript -->
            <div class="text-center text-gray-400 text-xs py-3" style="min-width: 120px;">
              Create batches<br>to sign off
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
