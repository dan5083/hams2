<%# app/views/works_orders/_ecard_operation.html.erb - Table Layout %>
<div class="bg-white border-2 border-gray-300">
  <!-- Table Header -->
  <div class="bg-gray-50 border-b border-gray-300">
    <div class="grid grid-cols-12 gap-2 p-3 font-semibold text-gray-700 text-sm">
      <div class="col-span-1">Op #</div>
      <div class="col-span-4">Operation Details</div>
      <div class="col-span-2">Current Batch</div>
      <div class="col-span-2">Batch Quantity</div>
      <div class="col-span-2">Status</div>
      <div class="col-span-1">Sign-Off</div>
    </div>
  </div>

  <!-- Operations Rows -->
  <% works_order.part.locked_operations.each_with_index do |operation, index| %>
    <% is_signed_off = operation_signed_off?(works_order, operation) %>
    <% is_contract_review = operation["display_name"].to_s.downcase.include?("contract review") %>

    <div class="border-b border-gray-200 <%= is_signed_off ? 'bg-green-50' : 'hover:bg-gray-50' %>"
         data-controller="ecard-operation"
         data-ecard-operation-position-value="<%= operation['position'] %>"
         data-ecard-operation-works-order-id-value="<%= works_order.id %>"
         data-ecard-operation-signed-off-value="<%= is_signed_off %>"
         data-ecard-operation-display-name-value="<%= operation['display_name'] %>">

      <div class="grid grid-cols-12 gap-2 p-3 items-center text-sm">

        <!-- Operation Number -->
        <div class="col-span-1">
          <span class="font-bold text-lg"><%= operation["position"] %></span>
        </div>

        <!-- Operation Details -->
        <div class="col-span-4">
          <div class="font-medium text-gray-900 mb-1">
            <%= operation["display_name"] %>
          </div>
          <div class="text-xs text-gray-600 line-clamp-2">
            <%= operation["operation_text"] %>
          </div>
          <% if operation["specifications"].present? %>
            <div class="text-xs text-blue-600 mt-1">
              Spec: <%= operation["specifications"] %>
            </div>
          <% end %>
        </div>

        <!-- Current Batch -->
        <div class="col-span-2" data-ecard-operation-target="currentBatch">
          <% if is_contract_review %>
            <span class="text-xs text-gray-500 italic">N/A</span>
          <% else %>
            <span class="text-xs text-gray-500">Loading...</span>
          <% end %>
        </div>

        <!-- Batch Quantity -->
        <div class="col-span-2" data-ecard-operation-target="batchQuantity">
          <% if is_contract_review %>
            <span class="text-xs text-gray-500 italic">N/A</span>
          <% else %>
            <span class="text-xs text-gray-500">-</span>
          <% end %>
        </div>

        <!-- Status -->
        <div class="col-span-2">
          <% if is_signed_off %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
              ✓ Complete
            </span>
          <% elsif is_contract_review %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
              Review Required
            </span>
          <% else %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800"
                  data-ecard-operation-target="statusBadge">
              Waiting for Batch
            </span>
          <% end %>
        </div>

        <!-- Sign-Off Button -->
        <div class="col-span-1">
          <% unless is_signed_off %>
            <%= form_with url: sign_off_operation_works_order_path(works_order),
                          method: :patch,
                          local: true,
                          class: "inline" do |form| %>
              <%= form.hidden_field :operation_position, value: operation["position"] %>
              <%= form.submit "Sign Off",
                  class: "bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-medium #{'opacity-50 cursor-not-allowed' unless is_contract_review}",
                  disabled: !is_contract_review,
                  data: {
                    "ecard-operation-target": "signOffButton",
                    action: "click->ecard-operation#beforeSignOff",
                    confirm: is_contract_review ? "Sign off contract review?" : "Sign off this operation for the current batch?"
                  } %>
            <% end %>
          <% else %>
            <span class="text-green-600 text-xs">✓</span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
