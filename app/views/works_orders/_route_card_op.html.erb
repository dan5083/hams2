<%# views/works_orders/_route_card_op.html.erb %>
<%# Render individual operation %>
<%
  has_variables = op[:all_variables]&.length&.> 0 || false
  top_style = has_variables ? 'border-bottom-style: dashed;' : ''
  bottom_style = has_variables ? 'border-top-style: dashed;' : ''
  rowspan = has_variables ? 2 : 1
  is_op_1 = op[:number] == 1

  # Parse operation content to extract OCV batches and test result lines
  main_content = []
  ocv_batches = []
  test_results = []
  in_ocv_section = false

  if op[:content]
    op[:content].each do |item|
      if item[:type] == "paragraph"
        text = item[:as_html] || ""

        # Split by newlines to process line by line
        lines = text.split(/\n/)

        lines.each do |line|
          # Check if this line contains OCV monitoring header (with or without bold)
          if line.match(/\*{0,2}OCV Monitoring:\*{0,2}/i)
            in_ocv_section = true
            next # Skip the header line itself
          end

          # Check for inline OCV monitoring format: *OCV monitoring; Batch ...*
          if line.match(/\*OCV monitoring;.*Batch.*\*/i)
            # Extract the batch info from within the asterisks
            batch_match = line.match(/\*OCV monitoring;\s*(Batch.*?)\*/)
            if batch_match
              ocv_batches << batch_match[1].strip
              # Remove the OCV monitoring portion from the line
              line = line.gsub(/\*OCV monitoring;.*?\*/, '').strip
              # Only add to main content if there's text remaining
              main_content << line unless line.empty?
              next
            end
          end

          # Check if this line is a batch line (multi-line format)
          if line.strip.match(/^Batch\s+___:/)
            ocv_batches << line.strip
          # Check if this line is a test result line (A), B), C), etc.)
          elsif line.strip.match(/^[A-F]\)/)
            test_results << line.strip
          else
            # Regular content line
            main_content << line unless line.strip.empty? && in_ocv_section
          end
        end
      end
    end
  end

  # Reconstruct main content HTML
  main_html = main_content.join("\n")
%>

<tr class="op op-<%= op[:number] %>">
  <td rowspan="<%= rowspan %>">
    <%= op[:number] %>
  </td>
  <td style="<%= top_style %>">
    <%= main_html.html_safe %>

    <% if test_results.any? %>
      <div class="ocv-section">
        <div class="ocv-header">Test Results:</div>
        <% test_results.each do |result| %>
          <div class="ocv-batch-card">
            <%= result.html_safe %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if ocv_batches.any? %>
      <div class="ocv-section">
        <div class="ocv-header">OCV Monitoring:</div>
        <% ocv_batches.each do |batch| %>
          <div class="ocv-batch-card">
            <%= batch.html_safe %>
          </div>
        <% end %>
      </div>
    <% end %>
  </td>

  <% if is_op_1 %>
    <!-- For OP 1, merge all batch columns into one -->
    <td colspan="<%= batch_cols %>" style="<%= top_style %>"></td>
  <% else %>
    <!-- For all other operations, use separate columns -->
    <% batch_cols.times do %>
      <td style="<%= top_style %>"></td>
    <% end %>
  <% end %>
</tr>

<% if has_variables %>
  <tr>
    <td style="<%= bottom_style %>">
      <% op[:all_variables].each do |variable| %>
        <div class="variable-row" style="font-weight:bold; text-align: right;">
          <span class="variable-name"><%= variable[:as_html]&.html_safe %></span>:
        </div>
      <% end %>
    </td>

    <% if is_op_1 %>
      <!-- For OP 1, merge all batch columns into one -->
      <td colspan="<%= batch_cols %>" style="<%= bottom_style %>"></td>
    <% else %>
      <!-- For all other operations, use separate columns -->
      <% batch_cols.times do %>
        <td style="<%= bottom_style %>"></td>
      <% end %>
    <% end %>
  </tr>
<% end %>
