<%# app/views/works_orders/_form.html.erb %>
<%= form_with model: works_order, local: true, class: "space-y-6" do |form| %>
  <% if works_order.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(works_order.errors.count, "error") %> prohibited this works order from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% works_order.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Works Order Details</h3>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <!-- Customer Order Selection -->
      <div>
        <%= form.label :customer_order_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :customer_order_id,
            options_for_select([['Select Customer Order', '']] + @customer_orders.map { |co| ["#{co.customer.name} - #{co.number}", co.id] }, works_order.customer_order_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Part Selection -->
      <div>
        <%= form.label :part_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :part_id,
            options_for_select([['Select Part', '']] + @parts.map { |p| ["#{p.display_name} (#{p.customer.name})", p.id] }, works_order.part_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- PPI Selection -->
      <div>
        <%= form.label :ppi_id, "Part Processing Instruction", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :ppi_id,
            options_for_select([['Select PPI', '']] + @ppis.map { |ppi| ["#{ppi.display_name} - #{ppi.customer.name}", ppi.id] }, works_order.ppi_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Release Level -->
      <div>
        <%= form.label :release_level_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :release_level_id,
            options_for_select([['Select Release Level', '']] + @release_levels.map { |rl| [rl.name, rl.id] }, works_order.release_level_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Transport Method -->
      <div>
        <%= form.label :transport_method_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :transport_method_id,
            options_for_select([['Select Transport Method', '']] + @transport_methods.map { |tm| [tm.name, tm.id] }, works_order.transport_method_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Quantity -->
      <div>
        <%= form.label :quantity, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.number_field :quantity,
            min: 1,
            placeholder: "Enter quantity",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
            required: true %>
      </div>
    </div>
  </div>

  <!-- Part Details Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Part Details</h3>
    <p class="text-sm text-gray-600 mb-4">These fields will be auto-populated when you select a PPI, but can be overridden if needed.</p>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <!-- Part Number -->
      <div>
        <%= form.label :part_number, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_field :part_number,
            placeholder: "Part number",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-mono" %>
      </div>

      <!-- Part Issue -->
      <div>
        <%= form.label :part_issue, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_field :part_issue,
            placeholder: "A",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-mono" %>
      </div>

      <!-- Part Description -->
      <div class="sm:col-span-2">
        <%= form.label :part_description, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.text_area :part_description,
            rows: 3,
            placeholder: "Part description",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
      </div>
    </div>
  </div>

  <!-- Pricing Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Pricing</h3>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
      <!-- Price Type -->
      <div>
        <%= form.label :price_type, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :price_type,
            options_for_select([
              ['Each', 'each'],
              ['Lot', 'lot']
            ], works_order.price_type || 'each'),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Each Price -->
      <div>
        <%= form.label :each_price, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.number_field :each_price,
            step: 0.01,
            min: 0,
            placeholder: "0.00",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        <p class="mt-1 text-xs text-gray-500">Price per individual part (for 'each' pricing)</p>
      </div>

      <!-- Lot Price -->
      <div>
        <%= form.label :lot_price, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.number_field :lot_price,
            step: 0.01,
            min: 0,
            placeholder: "0.00",
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
            required: true %>
        <p class="mt-1 text-xs text-gray-500">Total price for the entire lot</p>
      </div>
    </div>
  </div>

  <!-- Information Box -->
  <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
    <div class="flex">
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">Works Order Creation Notes</h3>
        <div class="mt-2 text-sm text-blue-700">
          <p>Select a Part Processing Instruction (PPI) to automatically populate part details and specifications.
          The PPI defines the process requirements for this part. You can override the part details if needed,
          but ensure they match the customer's requirements.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3">
    <%= link_to "Cancel", works_order.persisted? ? works_order : works_orders_path,
        class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" %>
    <%= form.submit works_order.persisted? ? "Update Works Order" : "Create Works Order",
        class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
  </div>
<% end %>
