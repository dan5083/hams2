<%# app/views/works_orders/_form.html.erb - With currency formatting %>
<%= form_with model: works_order, local: true, class: "space-y-6" do |form| %>
  <% if works_order.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(works_order.errors.count, "error") %> prohibited this works order from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% works_order.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Works Order Details</h3>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <!-- Customer Order Selection -->
      <div class="sm:col-span-2">
        <%= form.label :customer_order_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <% if @customer_order.present? && @customer_orders.length == 1 %>
          <!-- Show as read-only text when pre-selected -->
          <div class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-50 text-gray-900">
            <%= @customer_order.customer.name %> - <%= @customer_order.number %>
          </div>
          <%= form.hidden_field :customer_order_id, value: @customer_order.id %>
          <p class="mt-1 text-xs text-gray-500">Pre-selected from the customer order you came from</p>
        <% else %>
          <%= form.select :customer_order_id,
              options_for_select([['Select Customer Order', '']] + @customer_orders.map { |co| ["#{co.customer.name} - #{co.number}", co.id] }, works_order.customer_order_id),
              {},
              {
                class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                required: true
              } %>
        <% end %>
      </div>

      <!-- Part Number Selection -->
      <div class="sm:col-span-2">
        <%= form.label :part_id, "Part Number", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :part_id,
            options_for_select([['Select Part Number', '']] + @parts.map { |p| ["#{p.display_name}", p.id] }, works_order.part_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true,
              onchange: "updatePartDetails(this)"
            } %>
        <p class="mt-1 text-xs text-gray-500">Select the part number to be processed</p>
      </div>

      <!-- Hidden fields to store part details -->
      <%= form.hidden_field :part_number %>
      <%= form.hidden_field :part_issue %>
      <%= form.hidden_field :part_description %>

      <!-- Quantity -->
      <div>
        <%= form.label :quantity, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.number_field :quantity,
            placeholder: "Enter quantity",
            min: 1,
            class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
            required: true %>
      </div>

      <!-- Release Level -->
      <div>
        <%= form.label :release_level_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :release_level_id,
            options_for_select([['Select Release Level', '']] + @release_levels.map { |rl| [rl.name, rl.id] }, works_order.release_level_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>

      <!-- Transport Method -->
      <div>
        <%= form.label :transport_method_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :transport_method_id,
            options_for_select([['Select Transport Method', '']] + @transport_methods.map { |tm| [tm.name, tm.id] }, works_order.transport_method_id),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true
            } %>
      </div>
    </div>
  </div>

  <!-- Pricing Section -->
  <div class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Pricing</h3>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <!-- Price Type -->
      <div class="sm:col-span-2">
        <%= form.label :price_type, class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :price_type,
            options_for_select([
              ['Each (price per part)', 'each'],
              ['Lot (total job price)', 'lot']
            ], works_order.price_type || 'each'),
            {},
            {
              class: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              required: true,
              onchange: "togglePriceFields(this.value)"
            } %>
      </div>

      <!-- Each Price (shown when price_type is 'each') -->
      <div id="each_price_field" class="sm:col-span-2" style="<%= works_order.price_type == 'lot' ? 'display: none;' : '' %>">
        <%= form.label :each_price, "Price per part (£)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">£</span>
          </div>
          <%= form.number_field :each_price,
              step: 0.01,
              min: 0,
              placeholder: "0.00",
              class: "block w-full pl-7 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              id: "each_price_input",
              onblur: "formatCurrency(this)" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          The total job price will be calculated as: quantity × price per part
        </p>
      </div>

      <!-- Lot Price (shown when price_type is 'lot') -->
      <div id="lot_price_field" class="sm:col-span-2" style="<%= works_order.price_type == 'each' ? 'display: none;' : '' %>">
        <%= form.label :lot_price, "Total job price (£)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">£</span>
          </div>
          <%= form.number_field :lot_price,
              step: 0.01,
              min: 0,
              placeholder: "0.00",
              class: "block w-full pl-7 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
              id: "lot_price_input",
              onblur: "formatCurrency(this)" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          This is the total price for the entire job regardless of quantity
        </p>
      </div>
    </div>
  </div>

  <!-- Parts data for JavaScript -->
  <script>
    window.partsData = {
      <% @parts.each do |part| %>
        "<%= part.id %>": {
          "uniform_part_number": "<%= j part.uniform_part_number %>",
          "uniform_part_issue": "<%= j part.uniform_part_issue %>",
          "description": "<%= j (part.description || "#{part.uniform_part_number} component") %>"
        },
      <% end %>
    };
  </script>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3">
    <%= link_to "Cancel", works_order.persisted? ? works_order : works_orders_path,
        class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" %>
    <%= form.submit works_order.persisted? ? "Update Works Order" : "Create Works Order",
        class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
  </div>
<% end %>

<script>
// Currency formatting function
function formatCurrency(input) {
  let value = input.value;

  // Remove any non-numeric characters except decimal point
  value = value.replace(/[^\d.]/g, '');

  // Handle multiple decimal points
  const parts = value.split('.');
  if (parts.length > 2) {
    value = parts[0] + '.' + parts.slice(1).join('');
  }

  // Convert to number and back to ensure proper formatting
  const numValue = parseFloat(value);

  if (!isNaN(numValue) && numValue >= 0) {
    // Format to 2 decimal places
    input.value = numValue.toFixed(2);
  } else if (value === '' || value === '.') {
    // Allow empty or just decimal point while typing
    input.value = '';
  } else {
    // Invalid input, reset to 0.00
    input.value = '0.00';
  }
}

// Part selection handler
function updatePartDetails(selectElement) {
  const partId = selectElement.value;
  const partNumberField = document.getElementById('works_order_part_number');
  const partIssueField = document.getElementById('works_order_part_issue');
  const partDescriptionField = document.getElementById('works_order_part_description');

  if (partId && window.partsData) {
    const part = window.partsData[partId];
    if (part) {
      partNumberField.value = part.uniform_part_number;
      partIssueField.value = part.uniform_part_issue;
      partDescriptionField.value = part.description || `${part.uniform_part_number} component`;
    }
  } else {
    // Clear fields if no part selected
    partNumberField.value = '';
    partIssueField.value = '';
    partDescriptionField.value = '';
  }
}

// Pricing field toggle
function togglePriceFields(priceType) {
  const eachPriceField = document.getElementById('each_price_field');
  const lotPriceField = document.getElementById('lot_price_field');
  const eachPriceInput = document.getElementById('each_price_input');
  const lotPriceInput = document.getElementById('lot_price_input');

  if (priceType === 'each') {
    // Show each price field, hide lot price field
    eachPriceField.style.display = 'block';
    lotPriceField.style.display = 'none';

    // Make each price required, lot price not required
    eachPriceInput.required = true;
    lotPriceInput.required = false;

    // Clear lot price when switching to each pricing
    lotPriceInput.value = '';

  } else {
    // Show lot price field, hide each price field
    eachPriceField.style.display = 'none';
    lotPriceField.style.display = 'block';

    // Make lot price required, each price not required
    lotPriceInput.required = true;
    eachPriceInput.required = false;

    // Clear each price when switching to lot pricing
    eachPriceInput.value = '';
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  const priceTypeSelect = document.querySelector('#works_order_price_type');
  if (priceTypeSelect) {
    togglePriceFields(priceTypeSelect.value);
  }

  // Format existing values on page load
  const eachPriceInput = document.getElementById('each_price_input');
  const lotPriceInput = document.getElementById('lot_price_input');

  if (eachPriceInput && eachPriceInput.value) {
    formatCurrency(eachPriceInput);
  }

  if (lotPriceInput && lotPriceInput.value) {
    formatCurrency(lotPriceInput);
  }
});
</script>
